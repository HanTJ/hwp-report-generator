좋아요! “단일 요청 → 대화형(채팅) 서비스”로 전환하는 목표에 맞춰, 기존 `users / reports / token_usage` 스키마를 확장하는 **대화 중심 엔터티 설계**와 **DDL**, **마이그레이션 계획**, **API 변화**를 한 번에 정리해드릴게요.
(현재 스키마 기준은 온보딩 문서의 `users / reports / token_usage` 섹션을 따릅니다.)

# 제안하는 핵심 개념

- **Topic**: 사용자가 입력한 “보고서 주제” + AI가 가공한 “정식 주제명”을 보관하는 루트 엔터티
- **Message**: Topic 안에서 주고받는 모든 대화(사용자/AI). 각 메시지 단위로 **MD 산출물**과 **토큰 사용량**을 직접 연결
- **Artifact**: 메시지에서 파생된 파일(예: `md`, `hwpx`). 변환·번역 결과도 모두 아티팩트로 남김
- **Transformation**: 어떤 아티팩트를 어떤 작업(번역/형식변환)으로 생성했는지 “계보”를 남김
- **AI Usage(세분화)**: 기존 `token_usage`를 메시지 단위로 세분화 (보고서 단위가 아닌 “대화 턴” 단위)

# ERD (요약)

```
users (기존)
   ▲ 1
   │
   │ N
topics
   ▲ 1
   │
   │ N
messages ── 1:N ── ai_usage  (message별 토큰/지연시간/모델)
   │ 1
   │
   └── 1:N artifacts (md/hwpx 등 파일)
             ▲
             │ N
transformations (from_artifact_id → to_artifact_id, op=translate|convert)
```

# DDL (SQLite 예시)

```sql
-- 1) TOPICS: 주제 입력/가공 루트
CREATE TABLE IF NOT EXISTS topics (
  id              INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id         INTEGER NOT NULL,
  input_prompt    TEXT    NOT NULL,        -- 사용자가 1단계에서 입력
  generated_title TEXT    NOT NULL,        -- 2단계에서 AI가 생성/정규화
  language        TEXT    DEFAULT 'ko',    -- 주제 기본 언어(ko/en 등)
  status          TEXT    DEFAULT 'active',-- active|archived
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
CREATE INDEX IF NOT EXISTS idx_topics_user ON topics(user_id);
CREATE INDEX IF NOT EXISTS idx_topics_created ON topics(created_at);

-- 2) MESSAGES: 대화형 내역 (user/assistant/system)
CREATE TABLE IF NOT EXISTS messages (
  id              INTEGER PRIMARY KEY AUTOINCREMENT,
  topic_id        INTEGER NOT NULL,
  user_id         INTEGER,                 -- assistant면 NULL
  role            TEXT    NOT NULL,        -- 'user' | 'assistant' | 'system'
  content         TEXT    NOT NULL,        -- 원문(프롬프트/응답) 저장
  seq_no          INTEGER NOT NULL,        -- topic 내 오름차순 시퀀스
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE,
  FOREIGN KEY (user_id)  REFERENCES users(id)  ON DELETE SET NULL,
  UNIQUE(topic_id, seq_no)
);
CREATE INDEX IF NOT EXISTS idx_messages_topic ON messages(topic_id, seq_no);

-- 3) ARTIFACTS: 메시지에서 생성되는 실제 산출물(md, hwpx 등)
CREATE TABLE IF NOT EXISTS artifacts (
  id              INTEGER PRIMARY KEY AUTOINCREMENT,
  topic_id        INTEGER NOT NULL,
  message_id      INTEGER,                 -- 어떤 메시지에서 나왔는지
  kind            TEXT    NOT NULL,        -- 'md' | 'hwpx' | 'pdf' | ...
  locale          TEXT,                    -- 'ko' | 'en' 등
  version         INTEGER DEFAULT 1,
  filename        TEXT    NOT NULL,
  file_path       TEXT    NOT NULL,        -- FS 경로 (상대/절대)
  file_size       INTEGER DEFAULT 0,
  sha256          TEXT,                    -- 무결성 확인용(선택)
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (topic_id)   REFERENCES topics(id)   ON DELETE CASCADE,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE SET NULL
);
CREATE INDEX IF NOT EXISTS idx_artifacts_topic ON artifacts(topic_id, created_at);
CREATE INDEX IF NOT EXISTS idx_artifacts_message ON artifacts(message_id);

-- 4) TRANSFORMATIONS: 아티팩트 계보(번역/형식변환 등)
CREATE TABLE IF NOT EXISTS transformations (
  id                  INTEGER PRIMARY KEY AUTOINCREMENT,
  from_artifact_id    INTEGER NOT NULL,
  to_artifact_id      INTEGER NOT NULL,
  operation           TEXT    NOT NULL,    -- 'translate' | 'convert' | ...
  params_json         TEXT,                -- {"targetLocale":"ko","format":"hwpx"} 등
  created_at          TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (from_artifact_id) REFERENCES artifacts(id) ON DELETE CASCADE,
  FOREIGN KEY (to_artifact_id)   REFERENCES artifacts(id)   ON DELETE CASCADE,
  UNIQUE(from_artifact_id, to_artifact_id, operation)
);

-- 5) AI USAGE: 메시지 단위 토큰/지연시간/모델 비용 추적
CREATE TABLE IF NOT EXISTS ai_usage (
  id              INTEGER PRIMARY KEY AUTOINCREMENT,
  topic_id        INTEGER NOT NULL,
  message_id      INTEGER NOT NULL,
  model           TEXT    NOT NULL,        -- 예: claude-sonnet-4-5-20250929
  input_tokens    INTEGER DEFAULT 0,
  output_tokens   INTEGER DEFAULT 0,
  total_tokens    INTEGER GENERATED ALWAYS AS (input_tokens + output_tokens) VIRTUAL,
  latency_ms      INTEGER DEFAULT 0,
  created_at      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (topic_id)   REFERENCES topics(id)   ON DELETE CASCADE,
  FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE,
  UNIQUE(message_id)       -- 메시지 1개당 1건
);
CREATE INDEX IF NOT EXISTS idx_ai_usage_topic ON ai_usage(topic_id, created_at);

-- (선택) 6) 기존 reports 호환 뷰: hwpx 아티팩트를 보고서처럼 조회
CREATE VIEW IF NOT EXISTS reports_view AS
SELECT
  a.id                AS id,
  t.user_id           AS user_id,
  t.generated_title   AS title,
  a.filename          AS filename,
  a.file_path         AS file_path,
  a.file_size         AS file_size,
  a.created_at        AS created_at,
  t.id                AS topic_id
FROM artifacts a
JOIN topics t ON t.id = a.topic_id
WHERE a.kind = 'hwpx';
```

> 포인트
>
> - **Topic 1:N Message** 구조로 “대화형 기록”이 자연스럽게 누적됩니다.
> - **Message 1:N Artifact** 구조로 “각 턴에서 만들어진 MD, HWPX”를 연결합니다.
> - **AI Usage는 메시지 단위**로 추적하여 비용/성과를 미세하게 모니터링합니다.
> - **Transformation**으로 “MD→(한글 번역) MD→HWPX” 같은 작업 이력을 안전하게 복원할 수 있습니다.

# 플로우 대응 (요구하신 1~5단계)

1. 사용자가 보고서 **주제 입력**

- `POST /api/topics` → `topics(input_prompt)` 생성
- 서버에서 AI 호출로 `generated_title` 채워 `topics` 업데이트

2. **AI가 주제 생성 후 등록**

- `generated_title` 저장(필수)
- 첫 AI 메시지를 `messages(role='assistant', content=“주제 확정/요약”)`로 기록 (seq_no=1)

3. **대화 내역 기록**

- 사용자/AI 각각 `messages`에 턴-by-턴 누적
- 각 AI 응답 저장 시 `ai_usage` 동시 기록

4. **각 대화 내역에서 보고서용 MD 생성 & 경로 저장**

- 메시지에 대해 `POST /api/topics/{topicId}/messages/{messageId}/artifacts:generate-md`
- 생성된 MD 파일은 `artifacts(kind='md', locale='en'|'ko')`에 저장(파일시스템 경로 포함)
- 동일 메시지에서 여러 버전의 MD 생성 시 `version` 증가

5. **사용자가 MD 클릭 → 마음에 들면 ‘한글 변환된 실물 파일(HWPX)’ 다운로드**

- `POST /api/artifacts/{artifactId}:convert` with `{ "to": "hwpx", "targetLocale": "ko" }`
- HWPX 결과를 새 `artifacts(kind='hwpx', locale='ko')`에 기록 + `transformations`로 계보 연결
- `GET /api/artifacts/{id}/download` 로 즉시 다운로드

# API 스펙(요약)

- **Topics**

  - `POST /api/topics` → {topicId, generated_title, ...}
  - `GET /api/topics` → 내 토픽 목록(검색/페이지네이션, last_activity_at 소팅)
  - `GET /api/topics/{id}` → 토픽/최근 메시지 요약

- **Messages**

  - `GET /api/topics/{id}/messages` → 페이지네이션(sticky scroll)
  - `POST /api/topics/{id}/messages` → 새 사용자 메시지(→ AI 호출 → AI 응답 메시지 자동 append + ai_usage 기록)

- **Artifacts**

  - `POST /api/topics/{tid}/messages/{mid}/artifacts:generate-md`
  - `POST /api/artifacts/{aid}:convert` (`to: hwpx|pdf`, `targetLocale: 'ko'|'en' ...`)
  - `GET /api/artifacts/{aid}/download`

- **Analytics**

  - `GET /api/topics/{id}/usage` (메시지별 토큰/지연/모델)
  - `GET /api/usage/my` (기간별 합계, 월별 차트용)

# 마이그레이션 계획 (기존 데이터 보존)

1. **새 테이블 생성** (위 DDL 순서 유지)
2. **기존 reports → artifacts 이관**

   - 토픽이 없으므로, 보고서별로 임시 Topic 생성:

     - `topics(user_id, input_prompt=title, generated_title=title)`

   - 기존 `reports` 각 행을

     - `artifacts(kind='hwpx', locale='ko', filename, file_path, file_size, topic_id=위 토픽)`로 INSERT

   - (선택) `messages`에 “마이그레이션된 산출물 안내” 시스템 메시지 1건 작성

3. **기존 token_usage → ai_usage(가능한 범위 매핑)**

   - `report_id` 기준으로 매칭되는 `artifacts(kind='hwpx')` → 해당 `topic_id` 찾기
   - `messages`가 없던 시절 데이터이므로, 토픽 내 `seq_no=1`의 placeholder 메시지를 생성한 뒤 그 메시지에 `ai_usage` 연결(주기만큼)

4. **레거시 호환 뷰**

   - `reports_view`를 통해 기존 API/관리 페이지가 필요한 동안 최소한의 조회 호환성 유지

5. **코드 변경**

   - 산출물 접근/다운로드는 `artifacts` 기준으로 전환
   - 토큰/사용량 통계는 `ai_usage` 기준으로 대체

# 구현 체크리스트 (중요 포인트)

- **시퀀스 관리**: `messages.seq_no`는 “topic별 증가” 보장 (트랜잭션 내 `MAX(seq_no)+1`)
- **권한/소유권**: `topics.user_id` 기준으로 하위 모든 `messages/artifacts` 접근 제어
- **파일 정리**: 아티팩트 삭제 시 파일시스템의 실파일도 삭제(트랜잭션 후처리/작업 큐)
- **중복 생성 방지**: 동일 메시지에 같은 파라미터로 생성된 아티팩트는 `UNIQUE(message_id, kind, locale, version)` 정책 또는 `transformations`로 판단
- **인덱스**: 토픽별 최신 메시지 조회용 `idx_messages_topic(topic_id, seq_no)`로 무한스크롤 성능 확보
- **국문 변환 품질**: 번역-후-형식변환(번역된 MD → HWPX) 순서로, 변환 이력을 `transformations`에 남기기
- **감사 추적**: `ai_usage(latency_ms, model)`로 모델별 비용·속도 모니터링
- **호환성**: 기존 보고서 화면은 `reports_view`로 빠르게 유지, 신규 화면은 `artifacts`/`topics`로 전환

---

원하시면 위 스키마에 맞춘 **Pydantic 모델/Router 스텁**과, **migrate_db.py 초안**까지 바로 덧붙여 드릴게요.
