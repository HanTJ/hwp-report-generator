# Unit Spec: <기능명 또는 API 이름>

## 1. 요구사항 요약

- **목적:** <무엇을 하기 위한 기능인지 한 줄 요약>
- **유형:** ☐ 신규 ☐ 변경 ☐ 삭제
- **핵심 요구사항:**
  - 입력: <예: topic, userId 등>
  - 출력: <예: markdown, json, status code 등>
  - 예외/제약: <예: 토픽 누락 시 400 반환, 타임아웃 15s>
  - 처리흐름 요약: <한 줄로 동작 요약>

---

## 2. 구현 대상 파일

| 구분 | 경로                                    | 설명                  |
| ---- | --------------------------------------- | --------------------- |
| 신규 | backend/app/api/v1/report_controller.py | 신규 API 엔드포인트   |
| 변경 | backend/app/services/report_service.py  | 보고서 생성 로직 수정 |
| 참조 | backend/app/clients/llm_client.py       | LLM 호출 구조 참고    |

---

## 3. 동작 플로우 (Mermaid)

```mermaid
flowchart TD
    A[Client] -->|POST /api/v1/report| B(API)
    B --> C[ReportService.generate()]
    C --> D{Cache Hit?}
    D -- No --> E[LLM Client: callClaude()]
    E --> F[Convert Markdown → HWPX]
    F --> G[Save to DB]
    G --> H[Return JSON Response]
```

---

## 4. 테스트 계획

### 4.1 원칙

- **테스트 우선(TDD)**: 본 섹션의 항목을 우선 구현하고 코드 작성.
- **계층별 커버리지**: Unit → Integration → API(E2E-lite) 순서로 최소 P0 커버.
- **독립성/재현성**: 외부 연동(LLM/DB/File I/O)은 모킹 또는 임베디드 스토리지 사용.
- **판정 기준**: 기대 상태코드/스키마/부작용(저장/로그)을 명시적으로 검증.

### 4.2 구현 예상 테스트 항목(각 항목의 목적 포함)

| TC ID      | 계층 | 시나리오              | 목적(무엇을 검증?)                 | 입력/사전조건                        | 기대결과                                           |
| ---------- | ---- | --------------------- | ---------------------------------- | ------------------------------------ | -------------------------------------------------- |
| TC-API-001 | API  | 보고서 생성 성공      | API 계약/상태코드/응답 스키마 검증 | `POST /api/v1/report` `{topic:"AI"}` | `201`, `markdown` 필드 존재, 스키마 스냅샷 일치    |
| TC-API-002 | API  | 입력 누락(Validation) | 입력 검증 및 오류 매핑             | `{}`                                 | `400`, 에러코드 `VALIDATION_ERROR`, 메시지 키 존재 |
| TC-API-003 | API  | 비정상 타입           | 스키마 검증 강제 및 방어 로직      | `{topic: 123}`                       | `400`, 상세 사유 포함                              |
| TC-SVC-004 | Unit | 캐시 히트 경로        | 캐시 우선 반환·LLM 미호출          | 캐시에 동일 토픽 결과 존재           | LLM 호출 0회, 기존 값 반환                         |
| TC-SVC-005 | Unit | 캐시 미스 → LLM 호출  | LLM 호출 트리거/후처리/검증        | 캐시 미스, LLM 목 성공               | 정규식으로 마크다운 형식 간단 검증, 후처리 호출됨  |

### 4.3 샘플 테스트 코드

테스트 작성가이드 `backend/BACKEND_TEST.md`

---

## 5. 사용자 요청 프롬프트

**Original User Request:**

```
<사용자가 요청한 원본 프롬프트를 여기에 기록>
```

**요청 일시:** YYYY-MM-DD HH:MM

**컨텍스트/배경:**
- <사용자가 제공한 추가 컨텍스트나 배경 정보>
- <관련 이슈 링크나 참고 사항>

**명확화 Q&A:**
- Q: <Claude가 질문한 내용>
- A: <사용자 답변>

---

**Note:** 이 섹션은 요구사항의 원본 출처를 보존하여 구현 과정에서 의도를 재확인하고, 향후 변경 요청 시 초기 요구사항과의 차이를 추적하기 위한 목적입니다.
