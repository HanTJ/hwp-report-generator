# HWPX 파일 다운로드 기능 구현 계획

## 문서 정보
- **작성일**: 2025-10-29
- **대상**: 백엔드 개발자
- **구현 범위**: 백엔드 API 전용 (프론트엔드 제외)
- **구현 방식**: Option B - MD → HWPX 변환 API

---

## 1. 기능 개요

### 목적
사용자가 생성한 Markdown(MD) 보고서를 한글 워드프로세서(HWPX) 형식으로 변환하여 다운로드할 수 있는 기능을 제공합니다.

### 사용자 워크플로우 (User Workflow)

**⚠️ 중요**: 사용자는 MD 파일을 먼저 다운로드하여 내용을 검토한 후, 이상이 없으면 HWPX로 변환합니다.

```
1. 보고서 생성
   └─ POST /api/topics/generate → MD artifact 생성 (artifact_id=10)

2. MD 파일 다운로드 및 검토
   └─ GET /api/artifacts/10/download → report.md 다운로드
   └─ 사용자가 내용 확인 및 검토

3. 내용 확인 후 HWPX 변환
   └─ POST /api/artifacts/10/convert → HWPX artifact 생성 (artifact_id=11)

4. HWPX 파일 다운로드
   └─ GET /api/artifacts/11/download → report.hwpx 다운로드
```

### 기술적 플로우 (Technical Flow)

```
1. 사용자가 보고서 생성 → MD artifact 생성 (기존 기능)
2. 사용자가 MD 다운로드 → 내용 검토 (기존 다운로드 API 사용)
3. 프론트엔드에서 HWPX 변환 요청 → POST /api/artifacts/{artifact_id}/convert
4. 백엔드가 MD를 읽어 HWPHandler로 HWPX 생성
5. 새로운 HWPX artifact 저장 및 artifact_id 반환
6. 프론트엔드가 다운로드 요청 → GET /api/artifacts/{artifact_id}/download (기존 API 재사용)
```

### Option B를 선택한 이유
- **유연성**: MD와 HWPX를 별도 artifact로 관리하여 두 형식 모두 보존
- **성능**: 필요할 때만 변환 (on-demand conversion)
- **확장성**: 향후 PDF, DOCX 등 다른 형식 변환 시 동일 패턴 적용 가능
- **기존 인프라 활용**: 이미 구현된 다운로드 API 재사용

---

## 2. 현재 시스템 분석

### 2.1 기존 구현 현황

#### ✅ 완료된 기능
- **Artifact 관리**: 모델, DB, API 완전 구현
- **MD 파일 생성**: `/api/topics/generate` 엔드포인트에서 MD artifact 생성
- **파일 다운로드**: `/api/artifacts/{artifact_id}/download` 엔드포인트 구현
- **HWPHandler**: `app/utils/hwp_handler.py`에 HWPX 생성 로직 존재

#### ❌ 미구현 기능
- **MD → HWPX 변환 API**: 501 Not Implemented 상태
- **HWPHandler 통합**: 독립적으로 존재하나 artifact 시스템과 미연결

### 2.2 Artifact 시스템 구조

**데이터베이스 스키마**:
```sql
CREATE TABLE artifacts (
    id INTEGER PRIMARY KEY,
    topic_id INTEGER NOT NULL,           -- FK to topics
    message_id INTEGER NOT NULL,         -- FK to messages
    kind TEXT NOT NULL,                  -- md, hwpx, pdf
    locale TEXT NOT NULL DEFAULT 'ko',
    version INTEGER NOT NULL DEFAULT 1,
    filename TEXT NOT NULL,
    file_path TEXT NOT NULL,
    file_size INTEGER NOT NULL DEFAULT 0,
    sha256 TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (topic_id) REFERENCES topics(id) ON DELETE CASCADE,
    FOREIGN KEY (message_id) REFERENCES messages(id) ON DELETE CASCADE
)
```

**파일 저장 구조**:
```
backend/
└─ artifacts/
   └─ {topic_id}/
      └─ v{version}/
         ├─ report.md       (kind=MD)
         └─ report.hwpx     (kind=HWPX)
```

**Artifact Kind 열거형** (`shared/types/enums.py`):
```python
class ArtifactKind(str, Enum):
    MD = "md"
    HWPX = "hwpx"
    PDF = "pdf"
```

---

## 3. API 명세

### 3.1 MD → HWPX 변환 API

#### Endpoint
```
POST /api/artifacts/{artifact_id}/convert
```

#### 설명
지정된 MD artifact를 HWPX 형식으로 변환하여 새로운 artifact를 생성합니다.

#### Path Parameters
| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| artifact_id | integer | ✅ | 변환할 MD artifact의 ID |

#### Request Body
```json
{
  "target_format": "hwpx"  // 향후 확장: "pdf", "docx" 등
}
```

#### Success Response (200)
```json
{
  "success": true,
  "data": {
    "artifact_id": 123,
    "kind": "hwpx",
    "filename": "report.hwpx",
    "file_path": "D:/WorkSpace/hwp-report/hwp-report-generator/backend/artifacts/1/v1/report.hwpx",
    "file_size": 15234,
    "created_at": "2025-10-29T10:30:00"
  },
  "error": null,
  "meta": {
    "requestId": "req_abc123"
  },
  "feedback": []
}
```

#### Error Responses

**404 Not Found** - Artifact 없음:
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ARTIFACT.NOT_FOUND",
    "httpStatus": 404,
    "message": "아티팩트를 찾을 수 없습니다.",
    "traceId": "trace_xyz789"
  },
  "meta": {"requestId": "req_def456"},
  "feedback": []
}
```

**400 Bad Request** - MD가 아닌 artifact:
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ARTIFACT.INVALID_KIND",
    "httpStatus": 400,
    "message": "MD 형식의 아티팩트만 변환할 수 있습니다.",
    "details": {"current_kind": "hwpx"},
    "hint": "MD artifact를 선택해주세요.",
    "traceId": "trace_abc123"
  },
  "meta": {"requestId": "req_ghi789"},
  "feedback": []
}
```

**403 Forbidden** - 권한 없음:
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ARTIFACT.UNAUTHORIZED",
    "httpStatus": 403,
    "message": "이 아티팩트에 접근할 권한이 없습니다.",
    "traceId": "trace_def456"
  },
  "meta": {"requestId": "req_jkl012"},
  "feedback": []
}
```

**500 Internal Server Error** - 변환 실패:
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ARTIFACT.CONVERSION_FAILED",
    "httpStatus": 500,
    "message": "HWPX 변환 중 오류가 발생했습니다.",
    "details": {"error": "Template file not found"},
    "hint": "템플릿 파일이 올바른 위치에 있는지 확인해주세요.",
    "traceId": "trace_ghi789"
  },
  "meta": {"requestId": "req_mno345"},
  "feedback": []
}
```

### 3.2 파일 다운로드 API (기존 - 수정 금지)

#### ⚠️ 중요 사항
**이 API는 이미 완벽하게 구현되어 있으며, 절대 수정하지 않습니다.**

- ✅ MD 파일 다운로드 지원 (이미 동작 중)
- ✅ HWPX 파일 다운로드 지원 (이미 동작 중)
- ✅ 권한 검증 포함
- ✅ 파일 존재 여부 확인 포함

**사용 목적**:
- MD artifact 다운로드 → 사용자 내용 검토용
- HWPX artifact 다운로드 → 최종 파일 다운로드

#### Endpoint
```
GET /api/artifacts/{artifact_id}/download
```

#### 설명
지정된 artifact를 다운로드합니다. artifact의 kind(md, hwpx, pdf)에 따라 자동으로 적절한 MIME type을 설정합니다.

#### Success Response (200)

**MD 파일의 경우**:
- Content-Type: `text/markdown`
- Content-Disposition: `attachment; filename="report.md"`
- 파일 바이너리 스트림 반환

**HWPX 파일의 경우**:
- Content-Type: `application/x-hwpx`
- Content-Disposition: `attachment; filename="report.hwpx"`
- 파일 바이너리 스트림 반환

---

## 4. 구현 상세

### 4.1 구현 파일 목록

| 파일 | 목적 | 작업 |
|------|------|------|
| `backend/app/routers/artifacts.py` | API 엔드포인트 | `convert_artifact()` 함수 구현 (⚠️ 다운로드 API는 수정 금지) |
| `backend/app/utils/response_helper.py` | 에러 코드 | `ErrorCode.ARTIFACT_CONVERSION_FAILED`, `ARTIFACT_UNAUTHORIZED` 추가 |
| `backend/app/utils/hwp_handler.py` | HWPX 생성 | 기존 코드 활용 (수정 불필요) |
| `backend/app/utils/markdown_parser.py` | MD 파싱 | 신규 생성 (MD → content dict 변환) |
| `backend/templates/report_template.hwpx` | HWPX 템플릿 | 확인 (없으면 생성) |

### 4.2 구현 단계

#### Step 1: ErrorCode 추가

**파일**: `backend/app/utils/response_helper.py`

```python
class ErrorCode:
    # ... 기존 코드 ...

    # Artifacts
    ARTIFACT_NOT_FOUND = "ARTIFACT.NOT_FOUND"
    ARTIFACT_INVALID_KIND = "ARTIFACT.INVALID_KIND"
    ARTIFACT_DOWNLOAD_FAILED = "ARTIFACT.DOWNLOAD_FAILED"
    ARTIFACT_CONVERSION_FAILED = "ARTIFACT.CONVERSION_FAILED"  # 신규 추가
    ARTIFACT_UNAUTHORIZED = "ARTIFACT.UNAUTHORIZED"  # 신규 추가
```

#### Step 2: Markdown Parser 구현

**파일**: `backend/app/utils/markdown_parser.py` (신규 생성)

```python
"""
Markdown 파일을 파싱하여 HWPHandler에 필요한 content dict로 변환
"""
import re
from typing import Dict


def parse_markdown_to_content(md_text: str) -> Dict[str, str]:
    """
    Markdown 텍스트를 파싱하여 HWPHandler.generate_report()에 필요한 content dict로 변환

    Args:
        md_text: Markdown 형식의 텍스트

    Returns:
        Dict[str, str]: HWP 플레이스홀더에 매핑될 content 딕셔너리
        {
            "title": "보고서 제목",
            "summary": "요약 내용...",
            "background": "배경 내용...",
            "main_content": "주요 내용...",
            "conclusion": "결론 내용...",
            "title_summary": "요약",      # 섹션 제목 (옵션)
            "title_background": "배경 및 목적",
            "title_main_content": "주요 내용",
            "title_conclusion": "결론 및 제언"
        }
    """
    content = {
        "title": "",
        "summary": "",
        "background": "",
        "main_content": "",
        "conclusion": "",
        "title_summary": "요약",
        "title_background": "배경 및 목적",
        "title_main_content": "주요 내용",
        "title_conclusion": "결론 및 제언"
    }

    # 첫 번째 # 제목을 title로 추출
    title_match = re.search(r'^#\s+(.+)$', md_text, re.MULTILINE)
    if title_match:
        content["title"] = title_match.group(1).strip()

    # 섹션 추출 함수
    def extract_section(header_pattern: str, next_header_pattern: str = None) -> str:
        """특정 헤더 아래 내용을 추출"""
        if next_header_pattern:
            pattern = rf'{header_pattern}\n\n(.+?)(?=\n\n{next_header_pattern}|\Z)'
        else:
            pattern = rf'{header_pattern}\n\n(.+?)(?=\Z)'

        match = re.search(pattern, md_text, re.DOTALL | re.MULTILINE)
        if match:
            return match.group(1).strip()
        return ""

    # 각 섹션 추출 (## 헤더 기준)
    # Claude가 생성하는 MD 형식:
    # ## 요약
    # ## 배경 및 목적
    # ## 주요 내용
    # ## 결론 및 제언

    content["summary"] = extract_section(r'##\s*요약', r'##\s*배경')
    content["background"] = extract_section(r'##\s*배경[^#]*', r'##\s*주요')
    content["main_content"] = extract_section(r'##\s*주요\s*내용', r'##\s*결론')
    content["conclusion"] = extract_section(r'##\s*결론[^#]*')

    # 내용이 비어있으면 전체 텍스트를 main_content로 사용
    if not any([content["summary"], content["background"],
                content["main_content"], content["conclusion"]]):
        # 제목 다음 모든 내용을 main_content로
        if title_match:
            content["main_content"] = md_text[title_match.end():].strip()
        else:
            content["main_content"] = md_text.strip()

    return content


def extract_title_from_markdown(md_text: str) -> str:
    """
    Markdown에서 제목만 추출 (간편 함수)

    Args:
        md_text: Markdown 텍스트

    Returns:
        str: 추출된 제목 (없으면 "보고서")
    """
    title_match = re.search(r'^#\s+(.+)$', md_text, re.MULTILINE)
    if title_match:
        return title_match.group(1).strip()
    return "보고서"
```

#### Step 3: 변환 API 엔드포인트 구현

**파일**: `backend/app/routers/artifacts.py`

기존 `convert_artifact()` 함수를 다음과 같이 구현:

```python
@router.post("/{artifact_id}/convert", summary="Convert artifact to different format")
async def convert_artifact(
    artifact_id: int,
    current_user: User = Depends(get_current_active_user)
):
    """
    MD artifact를 HWPX 형식으로 변환하여 새로운 artifact 생성

    Path Parameters:
        - artifact_id: 변환할 MD artifact의 ID

    Returns:
        Standard ApiResponse with created HWPX artifact data

    Error Codes:
        - ARTIFACT.NOT_FOUND: Artifact not found
        - ARTIFACT.UNAUTHORIZED: User does not own this artifact
        - ARTIFACT.INVALID_KIND: Not a MD artifact
        - ARTIFACT.CONVERSION_FAILED: Conversion failed
    """
    # 1. Artifact 조회 및 검증
    artifact = ArtifactDB.get_artifact_by_id(artifact_id)

    if not artifact:
        return error_response(
            code=ErrorCode.ARTIFACT_NOT_FOUND,
            http_status=404,
            message="아티팩트를 찾을 수 없습니다."
        )

    # 2. 권한 확인 (topic owner인지 확인)
    topic = TopicDB.get_topic_by_id(artifact.topic_id)
    if not topic or (topic.user_id != current_user.id and not current_user.is_admin):
        return error_response(
            code=ErrorCode.ARTIFACT_UNAUTHORIZED,
            http_status=403,
            message="이 아티팩트에 접근할 권한이 없습니다."
        )

    # 3. MD artifact인지 확인
    if artifact.kind != ArtifactKind.MD:
        return error_response(
            code=ErrorCode.ARTIFACT_INVALID_KIND,
            http_status=400,
            message="MD 형식의 아티팩트만 변환할 수 있습니다.",
            details={"current_kind": artifact.kind},
            hint="MD artifact를 선택해주세요."
        )

    try:
        # 4. MD 파일 읽기
        md_file_path = Path(artifact.file_path)
        if not md_file_path.exists():
            return error_response(
                code=ErrorCode.ARTIFACT_NOT_FOUND,
                http_status=404,
                message="아티팩트 파일을 찾을 수 없습니다.",
                details={"file_path": str(md_file_path)}
            )

        with open(md_file_path, 'r', encoding='utf-8') as f:
            md_text = f.read()

        # 5. MD → content dict 변환
        from app.utils.markdown_parser import parse_markdown_to_content
        content = parse_markdown_to_content(md_text)

        # 6. HWPX 생성 (HWPHandler 사용)
        template_path = ProjectPath.BACKEND_ROOT / "templates" / "report_template.hwpx"
        if not template_path.exists():
            return error_response(
                code=ErrorCode.ARTIFACT_CONVERSION_FAILED,
                http_status=500,
                message="HWPX 템플릿 파일을 찾을 수 없습니다.",
                details={"template_path": str(template_path)},
                hint="backend/templates/report_template.hwpx 파일이 있는지 확인해주세요."
            )

        # 임시 디렉토리 설정
        temp_dir = ProjectPath.BACKEND_ROOT / "temp"
        temp_dir.mkdir(exist_ok=True)

        # HWPHandler로 HWPX 생성
        hwp_handler = HWPHandler(
            template_path=str(template_path),
            temp_dir=str(temp_dir),
            output_dir=str(temp_dir)  # 임시로 temp에 저장
        )

        # 임시 HWPX 파일 생성
        temp_hwpx_filename = f"temp_{artifact_id}_{int(time.time())}.hwpx"
        temp_hwpx_path = hwp_handler.generate_report(content, temp_hwpx_filename)

        # 7. Artifact 저장 경로 생성
        version = next_artifact_version(artifact.topic_id, ArtifactKind.HWPX, artifact.locale)
        base_dir, hwpx_path = build_artifact_paths(
            artifact.topic_id,
            version,
            "report.hwpx"
        )

        # 8. HWPX 파일 이동
        import shutil
        shutil.move(temp_hwpx_path, hwpx_path)

        # 9. 파일 정보 계산
        file_size = hwpx_path.stat().st_size
        file_hash = sha256_of(hwpx_path)

        # 10. Artifact DB 레코드 생성
        hwpx_artifact = ArtifactDB.create_artifact(
            artifact.topic_id,
            artifact.message_id,  # 동일한 message에 연결
            ArtifactCreate(
                kind=ArtifactKind.HWPX,
                locale=artifact.locale,
                version=version,
                filename=hwpx_path.name,
                file_path=str(hwpx_path),
                file_size=file_size,
                sha256=file_hash
            )
        )

        # 11. 성공 응답
        return success_response({
            "artifact_id": hwpx_artifact.id,
            "kind": hwpx_artifact.kind,
            "filename": hwpx_artifact.filename,
            "file_path": hwpx_artifact.file_path,
            "file_size": hwpx_artifact.file_size,
            "created_at": hwpx_artifact.created_at.isoformat()
        })

    except Exception as e:
        return error_response(
            code=ErrorCode.ARTIFACT_CONVERSION_FAILED,
            http_status=500,
            message="HWPX 변환 중 오류가 발생했습니다.",
            details={"error": str(e)}
        )
```

#### Step 4: 필요한 import 추가

**파일**: `backend/app/routers/artifacts.py` (상단에 추가)

```python
import time
from pathlib import Path
from app.utils.hwp_handler import HWPHandler
from app.database.topic_db import TopicDB
from app.utils.file_utils import next_artifact_version, build_artifact_paths, sha256_of
from shared.constants import ProjectPath
```

#### Step 5: 템플릿 파일 확인

**파일**: `backend/templates/report_template.hwpx`

존재 여부 확인:
```bash
ls -la backend/templates/report_template.hwpx
```

없을 경우:
- 기존 HWPX 템플릿 파일을 해당 경로에 배치
- 또는 `hwp_handler.py`의 `create_simple_template()` 메서드로 생성

---

## 5. 파일 저장 구조

### 5.1 디렉토리 구조

```
backend/
├─ artifacts/
│  └─ {topic_id}/
│     └─ v{version}/
│        ├─ report.md       # kind=MD, version=1
│        └─ report.hwpx     # kind=HWPX, version=1 (변환 후 생성)
│
├─ templates/
│  └─ report_template.hwpx  # HWPX 변환용 템플릿
│
└─ temp/                    # 임시 작업 디렉토리
   └─ work_*                # HWPHandler 작업 디렉토리 (자동 정리)
```

### 5.2 Version 관리

- **동일 topic_id + kind + locale**: version 증가
- **MD artifact**: version=1
- **HWPX artifact (첫 변환)**: version=1
- **HWPX artifact (재변환)**: version=2, 3, ...

예시:
```
topic_id=1, locale=ko

MD:   artifacts/1/v1/report.md    (version=1)
HWPX: artifacts/1/v1/report.hwpx  (version=1, 첫 변환)
HWPX: artifacts/1/v2/report.hwpx  (version=2, 재변환)
```

---

## 6. 에러 처리

### 6.1 ErrorCode 정의

| 코드 | HTTP 상태 | 설명 |
|------|----------|------|
| `ARTIFACT.NOT_FOUND` | 404 | Artifact 없음 또는 파일 없음 |
| `ARTIFACT.UNAUTHORIZED` | 403 | 사용자가 해당 topic 소유자 아님 |
| `ARTIFACT.INVALID_KIND` | 400 | MD가 아닌 artifact 변환 시도 |
| `ARTIFACT.CONVERSION_FAILED` | 500 | 변환 프로세스 실패 |

### 6.2 예외 시나리오

| 시나리오 | 처리 방법 |
|---------|----------|
| Artifact ID 존재하지 않음 | 404 NOT_FOUND |
| 사용자가 topic 소유자 아님 | 403 UNAUTHORIZED |
| MD가 아닌 artifact | 400 INVALID_KIND |
| MD 파일이 디스크에 없음 | 404 NOT_FOUND (파일 누락) |
| 템플릿 파일 없음 | 500 CONVERSION_FAILED |
| HWPHandler 실행 오류 | 500 CONVERSION_FAILED |
| 파일 저장 실패 | 500 CONVERSION_FAILED |

---

## 7. 테스트 시나리오

### 7.1 정상 케이스 (사용자 워크플로우 반영)

**Test Case 1: 전체 플로우 - MD 검토 후 HWPX 변환 및 다운로드**
```
1. 보고서 생성
   POST /api/topics/generate → MD artifact 생성 (artifact_id=10)

2. MD 파일 다운로드 (사용자 검토용)
   GET /api/artifacts/10/download
   → Content-Type: text/markdown
   → report.md 다운로드
   → 사용자가 내용 확인

3. HWPX 변환 요청
   POST /api/artifacts/10/convert
   → 응답:
   {
     "success": true,
     "data": {
       "artifact_id": 11,
       "kind": "hwpx",
       "filename": "report.hwpx",
       "file_size": 15234,
       ...
     }
   }

4. HWPX 파일 다운로드 (최종 파일)
   GET /api/artifacts/11/download
   → Content-Type: application/x-hwpx
   → report.hwpx 다운로드
```

**Test Case 2: MD 다운로드만 수행 (HWPX 변환 안 함)**
```
1. POST /api/topics/generate → MD artifact 생성 (artifact_id=10)
2. GET /api/artifacts/10/download → MD 파일 다운로드
3. (종료 - HWPX 변환하지 않음)
```

### 7.2 에러 케이스

**Test Case 3: 존재하지 않는 artifact**
```
POST /api/artifacts/99999/convert
→ 404 ARTIFACT.NOT_FOUND
```

**Test Case 4: HWPX artifact 변환 시도**
```
POST /api/artifacts/11/convert  (artifact_id=11은 이미 HWPX)
→ 400 ARTIFACT.INVALID_KIND
```

**Test Case 5: 타인의 artifact 변환 시도**
```
User A가 생성한 artifact_id=10
User B가 POST /api/artifacts/10/convert 호출
→ 403 ARTIFACT.UNAUTHORIZED
```

**Test Case 6: 템플릿 파일 없음**
```
backend/templates/report_template.hwpx 삭제
POST /api/artifacts/10/convert
→ 500 ARTIFACT.CONVERSION_FAILED
   "hint": "backend/templates/report_template.hwpx 파일이 있는지 확인해주세요."
```

### 7.3 통합 테스트

**전체 플로우 테스트**:
```python
# pytest를 사용한 통합 테스트 예시

def test_md_to_hwpx_conversion_flow(client, auth_headers):
    # 1. 보고서 생성 (MD artifact 생성)
    response = client.post(
        "/api/topics/generate",
        headers=auth_headers,
        json={"input_prompt": "디지털뱅킹 트렌드", "language": "ko"}
    )
    assert response.status_code == 200
    data = response.json()["data"]
    topic_id = data["topic_id"]
    md_artifact_id = data["artifact_id"]

    # 2. MD artifact 조회
    response = client.get(f"/api/artifacts/{md_artifact_id}", headers=auth_headers)
    assert response.status_code == 200
    assert response.json()["data"]["kind"] == "md"

    # 2-1. MD 파일 다운로드 (사용자 검토용 - 실제로는 사용자가 내용 확인)
    response = client.get(
        f"/api/artifacts/{md_artifact_id}/download",
        headers=auth_headers
    )
    assert response.status_code == 200
    assert response.headers["content-type"] == "text/markdown"
    assert len(response.content) > 0
    # 여기서 사용자는 다운로드한 MD 파일을 열어 내용 검토

    # 3. MD → HWPX 변환 (내용 확인 후)
    response = client.post(
        f"/api/artifacts/{md_artifact_id}/convert",
        headers=auth_headers
    )
    assert response.status_code == 200
    hwpx_data = response.json()["data"]
    hwpx_artifact_id = hwpx_data["artifact_id"]
    assert hwpx_data["kind"] == "hwpx"

    # 4. HWPX artifact 다운로드
    response = client.get(
        f"/api/artifacts/{hwpx_artifact_id}/download",
        headers=auth_headers
    )
    assert response.status_code == 200
    assert response.headers["content-type"] == "application/x-hwpx"
    assert len(response.content) > 0

    # 5. Topic의 모든 artifacts 조회 (MD + HWPX)
    response = client.get(
        f"/api/artifacts/topics/{topic_id}",
        headers=auth_headers
    )
    assert response.status_code == 200
    artifacts = response.json()["data"]["artifacts"]
    assert len(artifacts) == 2  # MD와 HWPX
    kinds = [a["kind"] for a in artifacts]
    assert "md" in kinds
    assert "hwpx" in kinds
```

---

## 8. 구현 체크리스트

### Backend 구현

- [ ] **ErrorCode 추가**
  - [ ] `ARTIFACT_CONVERSION_FAILED` 추가
  - [ ] `ARTIFACT_UNAUTHORIZED` 추가

- [ ] **Markdown Parser 구현**
  - [ ] `backend/app/utils/markdown_parser.py` 생성
  - [ ] `parse_markdown_to_content()` 함수 구현
  - [ ] 섹션 추출 로직 (요약, 배경, 주요내용, 결론)
  - [ ] 제목 추출 로직

- [ ] **변환 API 구현**
  - [ ] `artifacts.py`의 `convert_artifact()` 함수 구현
  - [ ] Artifact 조회 및 검증
  - [ ] 권한 확인 (topic owner)
  - [ ] MD kind 확인
  - [ ] MD 파일 읽기
  - [ ] HWPHandler 호출
  - [ ] HWPX artifact 저장
  - [ ] 에러 처리

- [ ] **Template 파일 준비**
  - [ ] `backend/templates/report_template.hwpx` 존재 확인
  - [ ] 없으면 템플릿 생성 또는 배치

- [ ] **테스트 작성**
  - [ ] 정상 케이스 테스트
  - [ ] 에러 케이스 테스트 (404, 400, 403, 500)
  - [ ] 통합 테스트 (생성 → 변환 → 다운로드)

- [ ] **문서화**
  - [ ] API 문서 업데이트 (Swagger)
  - [ ] Docstring 작성

---

## 9. 참고 사항

### 9.1 기존 구현된 다운로드 로직

**파일**: `backend/app/routers/artifacts.py`

```python
@router.get("/{artifact_id}/download", summary="Download artifact file")
async def download_artifact(
    artifact_id: int,
    current_user: User = Depends(get_current_active_user)
):
    """Download the artifact file."""
    artifact = ArtifactDB.get_artifact_by_id(artifact_id)

    if not artifact:
        return error_response(...)

    # 권한 확인
    topic = TopicDB.get_topic_by_id(artifact.topic_id)
    if not topic or topic.user_id != current_user.id:
        return error_response(...)

    # 파일 존재 확인
    file_path = Path(artifact.file_path)
    if not file_path.exists():
        return error_response(...)

    # MIME type 결정
    media_type_map = {
        "md": "text/markdown",
        "hwpx": "application/x-hwpx",
        "pdf": "application/pdf"
    }
    media_type = media_type_map.get(artifact.kind, "application/octet-stream")

    # FileResponse 반환
    return FileResponse(
        path=file_path,
        media_type=media_type,
        filename=artifact.filename
    )
```

### 9.2 HWPHandler 사용 예시

**파일**: `backend/app/utils/hwp_handler.py`

```python
# HWPHandler 사용법
handler = HWPHandler(
    template_path="backend/templates/report_template.hwpx",
    temp_dir="backend/temp",
    output_dir="backend/temp"
)

content = {
    "title": "디지털뱅킹 트렌드 보고서",
    "summary": "2025년 디지털뱅킹 주요 트렌드...",
    "background": "디지털 전환 가속화...",
    "main_content": "1. 모바일 우선 전략\n2. AI 기반 서비스...",
    "conclusion": "디지털뱅킹은 앞으로..."
}

hwpx_path = handler.generate_report(content, "output.hwpx")
# → backend/temp/output.hwpx 생성
```

### 9.3 프론트엔드 참고 (구현 제외)

프론트엔드 개발 시 다음 API 호출 순서 참고:

```typescript
// 1. 보고서 생성
const { topic_id, artifact_id: mdArtifactId } =
  await api.post('/api/topics/generate', { input_prompt: '...' });

// 2. HWPX 변환
const { artifact_id: hwpxArtifactId } =
  await api.post(`/api/artifacts/${mdArtifactId}/convert`);

// 3. HWPX 다운로드
window.location.href = `/api/artifacts/${hwpxArtifactId}/download`;
```

---

## 10. 추가 고려사항

### 10.1 성능 최적화

- **캐싱**: 동일 MD에서 여러 번 변환 시 기존 HWPX artifact 재사용 고려
- **비동기 처리**: 대용량 보고서의 경우 백그라운드 작업으로 처리 (Celery 등)
- **임시 파일 정리**: HWPHandler가 생성한 temp 파일 주기적 정리

### 10.2 향후 확장

- **PDF 변환**: `target_format=pdf` 지원
- **DOCX 변환**: `target_format=docx` 지원
- **일괄 변환**: 여러 artifact 동시 변환
- **템플릿 선택**: 사용자가 여러 템플릿 중 선택 가능

### 10.3 보안

- **파일 크기 제한**: 변환할 MD 파일 크기 제한 (예: 10MB)
- **Rate Limiting**: 변환 API 호출 빈도 제한
- **파일 검증**: MD 파일이 실제 텍스트 파일인지 검증

---

## 부록: 구현 예상 시간

| 작업 | 예상 시간 |
|------|----------|
| ErrorCode 추가 | 5분 |
| Markdown Parser 구현 | 1시간 |
| 변환 API 엔드포인트 구현 | 2시간 |
| 템플릿 파일 준비 및 검증 | 30분 |
| 테스트 작성 | 1.5시간 |
| 문서화 | 30분 |
| **총 예상 시간** | **약 5.5시간** |

---

## 주요 사항 요약 (Quick Reference)

### ⚠️ 절대 수정하지 말 것

1. **기존 다운로드 API (`GET /api/artifacts/{artifact_id}/download`)**
   - 이미 완벽하게 동작하고 있음
   - MD와 HWPX 모두 지원
   - 권한 검증 포함
   - **절대 수정하지 않음**

### ✅ 구현할 것

1. **변환 API (`POST /api/artifacts/{artifact_id}/convert`)**
   - MD artifact를 HWPX로 변환
   - 새로운 HWPX artifact 생성
   - artifact_id 반환

2. **Markdown Parser (`backend/app/utils/markdown_parser.py`)**
   - MD 텍스트 → content dict 변환
   - 섹션 추출 (요약, 배경, 주요내용, 결론)

3. **ErrorCode 추가**
   - `ARTIFACT_CONVERSION_FAILED`
   - `ARTIFACT_UNAUTHORIZED`

### 📋 사용자 워크플로우

```
보고서 생성 → MD 다운로드 → 검토 → HWPX 변환 → HWPX 다운로드
```

**핵심**: 사용자는 MD 파일을 먼저 검토한 후 HWPX로 변환합니다.

---

**문서 작성**: Backend 개발팀
**검토**: 기술 리드
**승인**: 프로젝트 매니저
**최종 수정**: 2025-10-29
