# HWPX 메시지 기반 다운로드 API 설계

## 목적
- 사용자가 특정 메시지(`message_id`)로 생성된 HWPX 보고서를 다운로드할 수 있도록 지원합니다.
- 해당 메시지로 생성된 HWPX 아티팩트가 없으면, 최신 MD 아티팩트를 기반으로 HWPX를 생성한 뒤 다운로드합니다.

---

## 엔드포인트
- Method: `GET`
- Path: `/api/artifacts/messages/{message_id}/hwpx/download`
- Query: `locale` (optional, default: `ko`)
- Response: `.hwpx` 파일 다운로드
  - `Content-Type: application/x-hwpx`
  - `Content-Disposition: attachment; filename="..."`

예시
```
GET /api/artifacts/messages/123/hwpx/download?locale=ko
```

---

## 동작 시나리오
1) 권한 확인
- `message_id` → `MessageDB.get_message_by_id`
- 메시지의 `topic_id` → `TopicDB.get_topic_by_id`
- `topic.user_id == current_user.id` 또는 `current_user.is_admin` 인 경우만 허용

2) HWPX 아티팩트 조회
- `ArtifactDB.get_artifacts_by_message(message_id)`
- kind=`hwpx`, `locale` 일치하는 최신 1건 선택
- 파일 경로 존재 시 바로 `FileResponse`로 다운로드

3) HWPX 미존재 시 MD 조회 및 변환
- 동일 `message_id`의 kind=`md`, `locale` 일치하는 최신 1건 선택
- MD 파일 경로 확인 후 내용을 읽어 `parse_markdown_to_content(md_text)`로 content dict 생성
- HWPX 템플릿 확인: `ProjectPath.BACKEND / "templates" / "report_template.hwpx"`
- `HWPHandler.generate_report(content, output_filename)`로 임시 `.hwpx` 생성

4) 아티팩트 저장/등록
- 버전: `next_artifact_version(topic_id, ArtifactKind.HWPX, locale)`
- 경로: `build_artifact_paths(topic_id, version, "report.hwpx")`
- 임시 파일 이동 → 파일 크기/해시(`sha256_of`) 계산 → `ArtifactDB.create_artifact(...)` 생성

5) 다운로드 응답
- `FileResponse(path=artifact.file_path, filename=artifact.filename, media_type="application/x-hwpx")`

---

## 에러/권한 처리
- 메시지 없음: `MESSAGE.NOT_FOUND` (404)
- 권한 없음: `TOPIC.UNAUTHORIZED` (403)
- 아티팩트/파일 없음: `ARTIFACT.NOT_FOUND` (404)
- 템플릿 없음/변환 실패: `ARTIFACT.CONVERSION_FAILED` (500)
- 기타 예외: `SERVER.INTERNAL_ERROR` (500)

응답 포맷 (예시)
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "ARTIFACT.NOT_FOUND",
    "message": "아티팩트 파일을 찾을 수 없습니다.",
    "details": {"file_path": "..."}
  },
  "meta": {"requestId": "req_..."},
  "feedback": []
}
```

---

## 구현 상세
- 라우터: `backend/app/routers/artifacts.py`
  - 신규 핸들러: `@router.get("/messages/{message_id}/hwpx/download", summary="Download HWPX by message")`
  - 로직: 권한 확인 → HWPX 조회 →(없으면) MD 조회/변환 → 파일 응답
- DB 유틸(선택): `ArtifactDB.get_latest_artifact_by_message_and_kind(message_id, kind, locale)`
  - 없으면 `get_artifacts_by_message()`로 필터링하여 최신 1건 선택
- 유틸 재사용
  - `parse_markdown_to_content` (MD → content dict)
  - `HWPHandler.generate_report` (content → hwpx 파일 생성)
  - `next_artifact_version`, `build_artifact_paths`, `sha256_of` (버전/경로/해시)
- 파일 배치
  - `backend/artifacts/{topic_id}/v{version}/report.hwpx`

권한 체크 예시(개요)
```python
msg = MessageDB.get_message_by_id(message_id)
if not msg:
    return error_response(ErrorCode.MESSAGE_NOT_FOUND, 404, "메시지를 찾을 수 없습니다.")

topic = TopicDB.get_topic_by_id(msg.topic_id)
if not topic or (topic.user_id != current_user.id and not current_user.is_admin):
    return error_response(ErrorCode.TOPIC_UNAUTHORIZED, 403, "이 리소스에 접근할 권한이 없습니다.")
```

변환 개요 코드(개요)
```python
# 1) HWPX 최신본 조회 → 있으면 다운로드
# 2) 없으면 MD 최신본 조회
with open(md_path, "r", encoding="utf-8") as f:
    md_text = f.read()
content = parse_markdown_to_content(md_text)

# 템플릿 확인 및 변환
template_path = ProjectPath.BACKEND / "templates" / "report_template.hwpx"
hwp = HWPHandler(str(template_path), str(ProjectPath.BACKEND / "temp"), str(ProjectPath.BACKEND / "temp"))
temp_hwpx = hwp.generate_report(content, f"temp_{message_id}.hwpx")

# 버전/경로 계산 후 이동 및 DB 생성
version = next_artifact_version(topic.id, ArtifactKind.HWPX, locale)
base_dir, hwpx_path = build_artifact_paths(topic.id, version, "report.hwpx")
shutil.move(temp_hwpx, hwpx_path)
file_size = hwpx_path.stat().st_size
file_hash = sha256_of(hwpx_path)
ArtifactDB.create_artifact(topic.id, message_id, ArtifactCreate(
  kind=ArtifactKind.HWPX, locale=locale, version=version,
  filename=hwpx_path.name, file_path=str(hwpx_path), file_size=file_size, sha256=file_hash
))
```

---

## 테스트 케이스
- HWPX 존재 시 바로 다운로드 (200, Content-Type 검증)
- HWPX 미존재 + MD 존재 시 변환 후 다운로드 (200)
- MD/HWPX 모두 없음 → 404 `ARTIFACT.NOT_FOUND`
- 파일 경로 유실(삭제됨) → 404 `ARTIFACT.NOT_FOUND`
- 권한 없는 사용자 요청 → 403 `TOPIC.UNAUTHORIZED`
- 헤더 검증: `Content-Type`, `Content-Disposition`
- 변환 후 아티팩트 DB 레코드 및 파일 생성 확인

---

## 완료 기준
- `message_id`만으로 `.hwpx` 다운로드 가능
- HWPX 없을 경우 자동 변환/저장 후 재다운로드 가능
- 권한 및 에러 응답 일관성 유지
- 관련 테스트 케이스 통과

---

## 향후 확장
- `target_format` 파라미터로 PDF 등 확장 (`pdf`, `docx`)
- 재생성 정책(강제 변환, 캐시 무효화) 옵션 추가
- 파일 보관/청소 정책(버전 보관 개수, 만료) 도입
