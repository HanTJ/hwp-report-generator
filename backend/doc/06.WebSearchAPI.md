# ì›¹ ê²€ìƒ‰ ê¸°ëŠ¥ ì œì–´ êµ¬í˜„ ê³„íš

## ğŸ“‹ ìš”ì•½

ì‚¬ìš©ìê°€ ì›¹ ê²€ìƒ‰ ì„ íƒ ì—¬ë¶€ì— ë”°ë¼ Claude APIì˜ web_search_20250131 ë„êµ¬ë¥¼ ì œì–´í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤.

---

## ğŸ¯ êµ¬í˜„ ëŒ€ìƒ

### API Endpoints
1. **POST /api/topics/generate** - ìµœì´ˆ ëŒ€í™” ìƒì„± ì‹œ
2. **POST /api/topics/{topic_id}/ask** - ëŒ€í™” ì´ì–´ê°€ê¸° ì‹œ

### í•µì‹¬ ìš”êµ¬ì‚¬í•­
- âœ… API í‘œì¤€ ì‘ë‹µ í˜•ì‹ ì¤€ìˆ˜ (success_response, error_response)
- âœ… ê¸°ë³¸ê°’: `enable_web_search = false`
- âœ… .envì—ì„œ tools JSON êµ¬ì¡° ë° system prompt ë¡œë“œ
- âœ… ê° ìš”ì²­ë§ˆë‹¤ ê°œë³„ì ìœ¼ë¡œ ì›¹ ê²€ìƒ‰ í™œì„±í™”/ë¹„í™œì„±í™” ì œì–´

---

## ğŸ“ êµ¬í˜„ ê³„íš

### 1ë‹¨ê³„: Pydantic ëª¨ë¸ ìˆ˜ì •

#### `backend/app/models/topic.py` - TopicCreate
```python
class TopicCreate(BaseModel):
    input_prompt: str = Field(..., min_length=1, max_length=1000)
    language: str = Field(default="ko")
    enable_web_search: bool = Field(
        default=False,
        description="ì›¹ ê²€ìƒ‰ í™œì„±í™” ì—¬ë¶€"
    )
```

#### `backend/app/models/message.py` - AskRequest
```python
class AskRequest(BaseModel):
    content: str = Field(...)
    artifact_id: Optional[int] = Field(default=None)
    include_artifact_content: bool = Field(default=True)
    max_messages: Optional[int] = Field(default=None)
    system_prompt: Optional[str] = Field(default=None)
    enable_web_search: bool = Field(
        default=False,
        description="ì›¹ ê²€ìƒ‰ í™œì„±í™” ì—¬ë¶€"
    )
```

**ì´ìœ **: ê° API ìš”ì²­ë§ˆë‹¤ ì›¹ ê²€ìƒ‰ì„ ê°œë³„ì ìœ¼ë¡œ ì œì–´í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

---

### 2ë‹¨ê³„: Claude Client ìˆ˜ì •

#### `backend/app/utils/claude_client.py`

**A. í´ë˜ìŠ¤ ì´ˆê¸°í™” ìˆ˜ì •**
```python
class ClaudeClient:
    def __init__(self):
        # ê¸°ì¡´ ì½”ë“œ...

        # .envì—ì„œ ì›¹ ê²€ìƒ‰ ë„êµ¬ ì„¤ì • ë¡œë“œ
        tools_json = os.getenv("CLAUDE_WEB_SEARCH_TOOLS")
        if tools_json:
            try:
                self.web_search_tools = json.loads(tools_json)
            except json.JSONDecodeError as e:
                logger.warning(f"ì›¹ ê²€ìƒ‰ ë„êµ¬ ì„¤ì • íŒŒì‹± ì‹¤íŒ¨: {e}")
                self.web_search_tools = [{"type": "web_search_20250131"}]
        else:
            self.web_search_tools = [{"type": "web_search_20250131"}]

        # .envì—ì„œ ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
        self.default_system_prompt = os.getenv(
            "CLAUDE_SYSTEM_PROMPT",
            """ë‹¹ì‹ ì€ ê¸ˆìœµ ê¸°ê´€ì˜ ì „ë¬¸ ë³´ê³ ì„œ ì‘ì„±ìì…ë‹ˆë‹¤..."""
        )
```

**B. generate_report() ë©”ì„œë“œ ìˆ˜ì •**
```python
def generate_report(self, topic: str, enable_web_search: bool = False) -> Dict[str, str]:
    """ì£¼ì œë¥¼ ë°›ì•„ ê¸ˆìœµ ì—…ë¬´ë³´ê³ ì„œ ë‚´ìš©ì„ ìƒì„±í•©ë‹ˆë‹¤.

    Args:
        topic: ë³´ê³ ì„œ ì£¼ì œ
        enable_web_search: ì›¹ ê²€ìƒ‰ í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’: False)

    Returns:
        Dict[str, str]: ë³´ê³ ì„œ ê° ì„¹ì…˜ì˜ ë‚´ìš©
    """
    # API íŒŒë¼ë¯¸í„° êµ¬ì„±
    api_params = {
        "model": self.model,
        "max_tokens": self.max_tokens,
        "messages": [{"role": "user", "content": prompt}]
    }

    # ì›¹ ê²€ìƒ‰ í™œì„±í™” ì‹œ tools ì¶”ê°€
    if enable_web_search:
        api_params["tools"] = self.web_search_tools
        logger.info("ì›¹ ê²€ìƒ‰ ë„êµ¬ í™œì„±í™”ë¨")

    message = self.client.messages.create(**api_params)
    # ë‚˜ë¨¸ì§€ ì½”ë“œ...
```

**C. chat_completion() ë©”ì„œë“œ ìˆ˜ì •**
```python
def chat_completion(
    self,
    messages: list[Dict[str, str]],
    system_prompt: str = None,
    enable_web_search: bool = False  # isWebSearch â†’ enable_web_searchë¡œ ë³€ê²½
) -> tuple[str, int, int]:
    """Chat-based completion for conversational report generation.

    Args:
        messages: ë©”ì‹œì§€ ë°°ì—´
        system_prompt: ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (Noneì´ë©´ .env ê¸°ë³¸ê°’ ì‚¬ìš©)
        enable_web_search: ì›¹ ê²€ìƒ‰ í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’: False)

    Returns:
        Tuple of (response_content, input_tokens, output_tokens)
    """
    # .envì—ì„œ ë¡œë“œí•œ ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
    if system_prompt is None:
        system_prompt = self.default_system_prompt

    # API íŒŒë¼ë¯¸í„° êµ¬ì„±
    api_params = {
        "model": self.model,
        "max_tokens": self.max_tokens,
        "system": system_prompt,
        "messages": messages
    }

    # ì›¹ ê²€ìƒ‰ í™œì„±í™” ì‹œ tools ì¶”ê°€
    if enable_web_search:
        api_params["tools"] = self.web_search_tools
        logger.info("ì›¹ ê²€ìƒ‰ ë„êµ¬ í™œì„±í™”ë¨")

    response = self.client.messages.create(**api_params)
    # ë‚˜ë¨¸ì§€ ì½”ë“œ...
```

**ì´ìœ **:
- .envì—ì„œ toolsì™€ promptë¥¼ ë¡œë“œí•˜ì—¬ ì¤‘ì•™ ì§‘ì¤‘ì‹ ê´€ë¦¬
- JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì•ˆì „í•œ ê¸°ë³¸ê°’ ì œê³µ
- ë¡œê¹…ì„ í†µí•œ ë””ë²„ê¹… í¸ì˜ì„±

---

### 3ë‹¨ê³„: Topics Router ìˆ˜ì •

#### `backend/app/routers/topics.py`

**A. /api/topics/generate ì—”ë“œí¬ì¸íŠ¸ (line 94-191)**
```python
@router.post("/generate", summary="ì£¼ì œ ì…ë ¥ â†’ ë³´ê³ ì„œ ìƒì„± â†’ MD ì €ì¥")
async def generate_topic_report(
    topic_data: TopicCreate,
    current_user: User = Depends(get_current_active_user)
):
    """ì‚¬ìš©ì ì£¼ì œë¥¼ ë°›ì•„ Claudeë¡œ ë³´ê³ ì„œ ìƒì„±...

    Request Body:
        - input_prompt: ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì£¼ì œ(í•„ìˆ˜)
        - language: ê¸°ë³¸ 'ko'
        - enable_web_search: ì›¹ ê²€ìƒ‰ í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’: false)
    """
    try:
        # ì…ë ¥ ê²€ì¦...

        # 1) Claude í˜¸ì¶œ - ì›¹ ê²€ìƒ‰ ì˜µì…˜ ì „ë‹¬
        start_ms = time.time()
        claude = ClaudeClient()
        result = claude.generate_report(
            topic_data.input_prompt.strip(),
            enable_web_search=topic_data.enable_web_search  # ì¶”ê°€
        )

        # ë‚˜ë¨¸ì§€ ì½”ë“œ ë™ì¼...
```

**B. /api/topics/{topic_id}/ask ì—”ë“œí¬ì¸íŠ¸ (line 482-825)**
```python
@router.post("/{topic_id}/ask", summary="Ask question in conversation")
async def ask(
    topic_id: int,
    body: AskRequest,
    current_user: User = Depends(get_current_active_user)
):
    """ëŒ€í™” ë§¥ë½ì—ì„œ ì§ˆë¬¸ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

    Request Body:
        - content: ì§ˆë¬¸ ë‚´ìš©
        - artifact_id: ì°¸ì¡° ì•„í‹°íŒ©íŠ¸ ID (optional)
        - include_artifact_content: ì•„í‹°íŒ©íŠ¸ ë‚´ìš© í¬í•¨ ì—¬ë¶€
        - max_messages: ìµœëŒ€ ë©”ì‹œì§€ ìˆ˜
        - system_prompt: ì»¤ìŠ¤í…€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (optional)
        - enable_web_search: ì›¹ ê²€ìƒ‰ í™œì„±í™” ì—¬ë¶€ (ê¸°ë³¸ê°’: false)
    """
    # ê¸°ì¡´ ê²€ì¦ ë¡œì§...

    # === 5ë‹¨ê³„: Claude í˜¸ì¶œ ===
    logger.info(f"[ASK] Calling Claude API - messages={len(claude_messages)}, web_search={body.enable_web_search}")

    try:
        t0 = time.time()

        claude_client = ClaudeClient()
        response_text, input_tokens, output_tokens = claude_client.chat_completion(
            claude_messages,
            system_prompt,
            enable_web_search=body.enable_web_search  # ì¶”ê°€
        )

        # ë‚˜ë¨¸ì§€ ì½”ë“œ ë™ì¼...
```

**ì´ìœ **:
- ì‚¬ìš©ì ìš”ì²­ì˜ enable_web_search ê°’ì„ Claude APIì— ì „ë‹¬
- ë¡œê¹…ì— ì›¹ ê²€ìƒ‰ ìƒíƒœ í¬í•¨í•˜ì—¬ ë””ë²„ê¹… í¸ì˜ì„± í–¥ìƒ

---

### 4ë‹¨ê³„: í™˜ê²½ ë³€ìˆ˜ ì„¤ì •

#### `.env` íŒŒì¼ì— ì¶”ê°€í•  ë‚´ìš©

```bash
# Claude API Configuration
CLAUDE_API_KEY=your_api_key_here
CLAUDE_MODEL=claude-sonnet-4-5-20250929

# Web Search Tools Configuration
# Claude APIì— ì „ë‹¬í•  tools ë°°ì—´ (JSON í˜•ì‹)
CLAUDE_WEB_SEARCH_TOOLS='[{"type": "web_search_20250131"}]'

# Default System Prompt
# ê¸°ë³¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (chat_completionì—ì„œ ì‚¬ìš©)
CLAUDE_SYSTEM_PROMPT='ë‹¹ì‹ ì€ ê¸ˆìœµ ê¸°ê´€ì˜ ì „ë¬¸ ë³´ê³ ì„œ ì‘ì„±ìì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ì „ë¬¸ì ì´ê³  ê²©ì‹ìˆëŠ” ê¸ˆìœµ ì—…ë¬´ë³´ê³ ì„œë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë³´ê³ ì„œëŠ” ë‹¤ìŒ ì„¹ì…˜ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
- # ì œëª© (H1)
- ## ìš”ì•½ (H2)
- ## ë°°ê²½ ë° ëª©ì  (H2)
- ## ì£¼ìš” ë‚´ìš© (H2)
- ## ê²°ë¡  ë° ì œì–¸ (H2)

ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•˜ë˜, ê¸ˆìœµ ìš©ì–´ì™€ ë°ì´í„°ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì—¬ ì‹ ë¢°ì„±ì„ ë†’ì—¬ì£¼ì„¸ìš”.
ëª¨ë“  ì¶œë ¥ì€ Markdown í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.'
```

**ì£¼ì˜ì‚¬í•­**:
- JSON ë¬¸ìì—´ì€ ì‘ì€ë”°ì˜´í‘œë¡œ ê°ì‹¸ê¸° (í°ë”°ì˜´í‘œëŠ” JSON ë‚´ë¶€ì—ì„œ ì‚¬ìš©)
- í”„ë¡¬í”„íŠ¸ëŠ” ì—¬ëŸ¬ ì¤„ë¡œ ì‘ì„± ê°€ëŠ¥

---

### 5ë‹¨ê³„: CLAUDE.md ë¬¸ì„œ ì—…ë°ì´íŠ¸

```markdown
## Environment Setup

Create `backend/.env` file:
```
CLAUDE_API_KEY=your_api_key_here
CLAUDE_MODEL=claude-sonnet-4-5-20250929

# Web Search Configuration
CLAUDE_WEB_SEARCH_TOOLS='[{"type": "web_search_20250131"}]'

# System Prompt
CLAUDE_SYSTEM_PROMPT='ë‹¹ì‹ ì€ ê¸ˆìœµ ê¸°ê´€ì˜ ì „ë¬¸ ë³´ê³ ì„œ ì‘ì„±ìì…ë‹ˆë‹¤...'

# JWT Configuration
JWT_SECRET_KEY=your-secret-key-change-this
...
```
```

---

## ğŸ” ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì½”ë“œ í’ˆì§ˆ
- [ ] API ì‘ë‹µ í‘œì¤€ ì¤€ìˆ˜ (success_response, error_response)
- [ ] ErrorCode ìƒìˆ˜ ì‚¬ìš© (í•˜ë“œì½”ë”© ê¸ˆì§€)
- [ ] Google Style Docstring ì‘ì„±
- [ ] íƒ€ì… íŒíŒ… ì‚¬ìš©
- [ ] í•œê¸€ ì—ëŸ¬ ë©”ì‹œì§€

### ê¸°ëŠ¥ ê²€ì¦
- [ ] enable_web_search=falseì¼ ë•Œ tools ë¯¸í¬í•¨
- [ ] enable_web_search=trueì¼ ë•Œ tools í¬í•¨
- [ ] .env íŒŒì‹± ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
- [ ] ë¡œê¹…ì— ì›¹ ê²€ìƒ‰ ìƒíƒœ í‘œì‹œ

### í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤
1. **ì›¹ ê²€ìƒ‰ ë¹„í™œì„±í™” (ê¸°ë³¸ê°’)**
   - Request: `{"input_prompt": "í…ŒìŠ¤íŠ¸", "enable_web_search": false}`
   - ê²€ì¦: Claude API í˜¸ì¶œ ì‹œ tools ë¯¸í¬í•¨

2. **ì›¹ ê²€ìƒ‰ í™œì„±í™”**
   - Request: `{"input_prompt": "í…ŒìŠ¤íŠ¸", "enable_web_search": true}`
   - ê²€ì¦: Claude API í˜¸ì¶œ ì‹œ tools í¬í•¨

3. **.env íŒŒì‹± ì˜¤ë¥˜**
   - ì˜ëª»ëœ JSON ì„¤ì •
   - ê²€ì¦: ê¸°ë³¸ê°’ìœ¼ë¡œ fallback, ê²½ê³  ë¡œê·¸ ì¶œë ¥

---

## âš ï¸ ë³´ì™„ í•„ìš” ì‚¬í•­

### 1. JSON íŒŒì‹± ì•ˆì „ì„±
- .envì˜ JSONì´ ì˜ëª»ëœ í˜•ì‹ì¼ ê²½ìš° ì•ˆì „í•œ ê¸°ë³¸ê°’ ì‚¬ìš©
- ê²½ê³  ë¡œê·¸ ì¶œë ¥

### 2. ì„±ëŠ¥ ìµœì í™”
- JSON íŒŒì‹±ì„ __init__ì—ì„œ í•œ ë²ˆë§Œ ìˆ˜í–‰ (í´ë˜ìŠ¤ ë³€ìˆ˜ ìºì‹±)
- ë§¤ ìš”ì²­ë§ˆë‹¤ íŒŒì‹±í•˜ì§€ ì•ŠìŒ

### 3. í…ŒìŠ¤íŠ¸ ì¶”ê°€ ê¶Œì¥
- `tests/test_utils_claude_client.py`ì— ì›¹ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸ ì¶”ê°€
- `tests/test_routers_topics.py`ì— enable_web_search í…ŒìŠ¤íŠ¸ ì¶”ê°€

### 4. Frontend ì—°ë™ (ë³„ë„ ì‘ì—…)
- ì›¹ ê²€ìƒ‰ í™œì„±í™” ì²´í¬ë°•ìŠ¤ UI ì¶”ê°€ í•„ìš”
- API í˜¸ì¶œ ì‹œ enable_web_search íŒŒë¼ë¯¸í„° ì „ë‹¬

---

## ğŸ“Š ì˜ˆìƒ ì˜í–¥ ë²”ìœ„

| íŒŒì¼ | ìˆ˜ì • ë‚´ìš© | ì˜í–¥ë„ |
|------|-----------|--------|
| `models/topic.py` | TopicCreateì— í•„ë“œ ì¶”ê°€ | ë‚®ìŒ |
| `models/message.py` | AskRequestì— í•„ë“œ ì¶”ê°€ | ë‚®ìŒ |
| `utils/claude_client.py` | .env ë¡œë”© ë° íŒŒë¼ë¯¸í„° ì¶”ê°€ | ì¤‘ê°„ |
| `routers/topics.py` | íŒŒë¼ë¯¸í„° ì „ë‹¬ | ë‚®ìŒ |
| `CLAUDE.md` | ë¬¸ì„œ ì—…ë°ì´íŠ¸ | ë‚®ìŒ |

---

## ğŸš€ êµ¬í˜„ ìˆœì„œ

1. `.env` íŒŒì¼ì— í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
2. `models/topic.py` ìˆ˜ì •
3. `models/message.py` ìˆ˜ì •
4. `utils/claude_client.py` ìˆ˜ì •
5. `routers/topics.py` ìˆ˜ì •
6. `CLAUDE.md` ë¬¸ì„œ ì—…ë°ì´íŠ¸
7. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë° ê²€ì¦

ì´ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ë©´ ì•ˆì „í•˜ê²Œ ê¸°ëŠ¥ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## ğŸ“Œ ì°¸ê³  ì‚¬í•­

### Claude API Tools ë¬¸ì„œ
- Web Search Tool: `web_search_20250131`
- ê³µì‹ ë¬¸ì„œ: https://docs.anthropic.com/claude/docs/tool-use

### ê´€ë ¨ íŒŒì¼
- `backend/app/routers/topics.py` - API ì—”ë“œí¬ì¸íŠ¸
- `backend/app/utils/claude_client.py` - Claude API í´ë¼ì´ì–¸íŠ¸
- `backend/app/models/topic.py` - Topic ëª¨ë¸
- `backend/app/models/message.py` - Message ëª¨ë¸
- `CLAUDE.md` - í”„ë¡œì íŠ¸ ë¬¸ì„œ

---

**ì‘ì„±ì¼**: 2025-10-31
**ë²„ì „**: 1.0
**ì‘ì„±ì**: Claude Code
