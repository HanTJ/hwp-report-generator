# ë©”ì‹œì§€ ì²´ì´ë‹(ëŒ€í™” ì»¨í…ìŠ¤íŠ¸) êµ¬í˜„ ê³„íš (ê°œì •íŒ)

## ë¬¸ì„œ ì •ë³´
- **ì‘ì„±ì¼**: 2025-10-29
- **ê°œì •ì¼**: 2025-10-30
- **ë²„ì „**: 2.0
- **ëŒ€ìƒ**: ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì
- **ë²”ìœ„**: ë°±ì—”ë“œ API + í”„ë¡ íŠ¸ UI ì—°ë™ + í…ŒìŠ¤íŠ¸
- **ê´€ë ¨ íŒŒì¼**:
  - backend/app/routers/messages.py
  - backend/app/utils/claude_client.py
  - backend/app/database/{topic_db.py,message_db.py,ai_usage_db.py,artifact_db.py}
  - backend/app/utils/response_helper.py
  - shared/types/enums.py

---

## ğŸ“‹ ê°œì • ì´ë ¥

### v2.0 (2025-10-30)
- âœ… API ê²½ë¡œ ë‹¨ìˆœí™”: `/api/topics/{topic_id}/messages/ask` â†’ `/api/topics/{topic_id}/ask`
- âœ… Request Body ì˜µì…˜ êµ¬ì¡° ë‹¨ìˆœí™” (80/20 ì›ì¹™ ì ìš©)
- âœ… ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± ë¡œì§ ëª…í™•í™” (ëª…ì‹œì  ê·œì¹™ ì •ì˜)
- âœ… ErrorCode ì¶”ê°€ ì •ì˜ (MESSAGE.CONTEXT_TOO_LARGE ë“±)
- âœ… ì•„í‹°íŒ©íŠ¸ ì €ì¥ ì •ì±… ëª…í™•í™” (ëª¨ë“  ì‘ë‹µ í•„ìˆ˜ ì €ì¥)
- âœ… ë¡œê¹… ì „ëµ ì¶”ê°€ (ê° ë‹¨ê³„ë³„ ìƒì„¸ ë¡œê¹…)

---

## 1. ê¸°ëŠ¥ ê°œìš”

### ëª©ì 
- í™”ë©´ì—ì„œ ì‚¬ìš©ìê°€ ëŒ€í™”ë¥¼ ì´ì–´ê°ˆ ìˆ˜ ìˆë„ë¡ "ë©”ì‹œì§€ ì²´ì´ë‹"ì„ ì œê³µí•œë‹¤.
- í™”ë©´ ì…ë ¥ í”„ë¡¬í”„íŠ¸ì™€ í•´ë‹¹ í† í”½(topic)ì— ì €ì¥ëœ ëª¨ë“  ë©”ì‹œì§€(`messages.content`)ë¥¼ í¬í•¨í•´ Claudeì— ì§ˆì˜í•œë‹¤.
- ì‘ë‹µì€ Markdownìœ¼ë¡œ ë°˜í™˜í•˜ê³ , ë©”ì‹œì§€Â·í† í° ì‚¬ìš©ëŸ‰Â·**ì•„í‹°íŒ©íŠ¸(MD íŒŒì¼)**ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì— ê¸°ë¡í•œë‹¤.
- **ëª¨ë“  assistant ì‘ë‹µì€ MD íŒŒì¼ë¡œ ì €ì¥**ë˜ì–´ ë²„ì „ ê´€ë¦¬ ë° HWPX ë³€í™˜ì— í™œìš©ëœë‹¤.

### ì‚¬ìš©ì í”Œë¡œìš°
```
1) ì‚¬ìš©ìê°€ í™”ë©´ì—ì„œ ì¶”ê°€ ì§ˆë¬¸ ì…ë ¥ (React í´ë¼ì´ì–¸íŠ¸)
   - ì„ íƒ ì˜µì…˜(ê°„ì†Œí™”):
     * artifact_id: íŠ¹ì • ë¬¸ì„œ ì°¸ì¡° (nullì´ë©´ ìµœì‹  ë¬¸ì„œ ìë™ ì‚¬ìš©)
     * include_artifact_content: íŒŒì¼ ë‚´ìš© í¬í•¨ ì—¬ë¶€ (ê¸°ë³¸ true)

2) ë°±ì—”ë“œì—ì„œ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
   - user ë©”ì‹œì§€: ëª¨ë‘ í¬í•¨ (max_messages ì œí•œ ê°€ëŠ¥)
   - assistant ë©”ì‹œì§€: ì°¸ì¡° ë¬¸ì„œë¥¼ ìƒì„±í•œ ë©”ì‹œì§€ 1ê±´ë§Œ í¬í•¨
   - ë¬¸ì„œ ë‚´ìš©: include_artifact_content=trueì¼ ë•Œ ë³„ë„ ë©”ì‹œì§€ë¡œ ì£¼ì…

3) Claude í˜¸ì¶œ ë° ì‘ë‹µ ì €ì¥
   - MD íŒŒì¼ ìë™ ìƒì„± (ëª¨ë“  ì‘ë‹µ í•„ìˆ˜)
   - ë©”ì‹œì§€/ì‚¬ìš©ëŸ‰/ì•„í‹°íŒ©íŠ¸ DB ê¸°ë¡
```

### ê¸°ìˆ ì  í”Œë¡œìš°
```
[í”„ë¡ íŠ¸] input â†’ POST /api/topics/{topic_id}/ask
     â†“
[ë°±ì—”ë“œ] ê¶Œí•œ ê²€ì¦ â†’ user ë©”ì‹œì§€ ì €ì¥ â†’ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
     â†“
[Claude] chat_completion(system + messages[]) í˜¸ì¶œ
     â†“
[ë°±ì—”ë“œ] assistant ë©”ì‹œì§€ ì €ì¥ â†’ MD íŒŒì¼ ì €ì¥(í•„ìˆ˜) â†’ Artifact ìƒì„± â†’ AiUsage ì €ì¥
     â†“
[í”„ë¡ íŠ¸] ë©”ì‹œì§€ ëª©ë¡ ê°±ì‹ , ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ, í† í° ì‚¬ìš©ëŸ‰ UI í‘œì‹œ
```

---

## 2. API ëª…ì„¸: ë©”ì‹œì§€ ì²´ì´ë‹ (ê°„ì†Œí™”)

### Endpoint (ê°œì •)
```
POST /api/topics/{topic_id}/ask
```

**ë³€ê²½ ì´ìœ **: `/messages`ê°€ ì¤‘ë³µë¨. í† í”½ì— ì§ˆë¬¸í•œë‹¤ëŠ” ì˜ë¯¸ê°€ ë” ëª…í™•í•¨.

### Path Parameters
| ì´ë¦„ | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… |
|---|---|---|---|
| topic_id | integer | âœ… | ëŒ€í™”ê°€ ì†í•œ í† í”½ ID |

### Request Body (ë‹¨ìˆœí™”)
```json
{
  "content": "ì´ì „ ë¶„ì„ì— ì´ì–´ ESG ë¦¬ìŠ¤í¬ í•­ëª©ì„ í™•ì¥í•´ ì£¼ì„¸ìš”.",
  "artifact_id": 123,
  "include_artifact_content": true,
  "max_messages": 50,
  "system_prompt": "ì„ íƒì  ì»¤ìŠ¤í…€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸"
}
```

**í•„ë“œ ì„¤ëª…**:
| í•„ë“œ | íƒ€ì… | í•„ìˆ˜ | ê¸°ë³¸ê°’ | ì„¤ëª… |
|------|------|------|--------|------|
| content | string | âœ… | - | ì‚¬ìš©ì ì…ë ¥ (1~50,000ì) |
| artifact_id | integer \| null | âŒ | null | ì°¸ì¡°í•  MD ì•„í‹°íŒ©íŠ¸ ID. nullì´ë©´ ìµœì‹  MD ìë™ ì‚¬ìš© |
| include_artifact_content | boolean | âŒ | true | íŒŒì¼ ë‚´ìš©ì„ ì»¨í…ìŠ¤íŠ¸ì— í¬í•¨í• ì§€ ì—¬ë¶€. falseë©´ í•´ë‹¹ assistant ë©”ì‹œì§€ë§Œ í¬í•¨ |
| max_messages | integer | âŒ | null | í¬í•¨í•  ìµœëŒ€ ì‚¬ìš©ì ë©”ì‹œì§€ ìˆ˜ (nullì´ë©´ ì „ì²´) |
| system_prompt | string | âŒ | ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ | ì»¤ìŠ¤í…€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (í† í”½ ì£¼ì œë¡œ ìë™ ë³´ê°•ë¨) |

**ë‹¨ìˆœí™” ì „í›„ ë¹„êµ**:
```json
// ì´ì „ (v1.0)
{
  "content": "...",
  "options": {
    "reference_mode": "latest",
    "md_artifact_id": 123,
    "md_reference_via": "artifact",
    "md_context_mode": "full",
    "md_max_chars": 30000,
    "max_context_messages": 50,
    "system_prompt": "..."
  }
}

// í˜„ì¬ (v2.0 - 80%ëŠ” ê¸°ë³¸ê°’ ì‚¬ìš©)
{
  "content": "...",
  "artifact_id": 123,  // nullì´ë©´ latest
  "include_artifact_content": true  // falseë©´ assistantë§Œ
}
```

### Success Response (200) â€” í‘œì¤€ ê·œê²© ì¤€ìˆ˜
```json
{
  "success": true,
  "data": {
    "topic_id": 12,
    "user_message": {
      "id": 101,
      "topic_id": 12,
      "role": "user",
      "content": "ì´ì „ ë¶„ì„ì— ì´ì–´ ESG ë¦¬ìŠ¤í¬ í•­ëª©ì„ í™•ì¥í•´ ì£¼ì„¸ìš”.",
      "seq_no": 7,
      "created_at": "2025-10-30T10:30:00"
    },
    "assistant_message": {
      "id": 102,
      "topic_id": 12,
      "role": "assistant",
      "content": "# ESG ë¦¬ìŠ¤í¬ í™•ì¥ ë¶„ì„\n\n## ìš”ì•½\n...",
      "seq_no": 8,
      "created_at": "2025-10-30T10:30:05"
    },
    "artifact": {
      "id": 345,
      "kind": "md",
      "filename": "report.md",
      "file_path": "D:/WorkSpace/.../backend/artifacts/12/v3/report.md",
      "file_size": 5432,
      "version": 3,
      "created_at": "2025-10-30T10:30:05"
    },
    "usage": {
      "model": "claude-sonnet-4-5-20250929",
      "input_tokens": 2300,
      "output_tokens": 950,
      "latency_ms": 3200
    }
  },
  "error": null,
  "meta": {
    "requestId": "req_abc123"
  },
  "feedback": []
}
```

### Error Responses

**400 Bad Request â€” ì…ë ¥ ê²€ì¦ ì‹¤íŒ¨**
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "VALIDATION.REQUIRED_FIELD",
    "httpStatus": 400,
    "message": "ì…ë ¥ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.",
    "hint": "1ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.",
    "traceId": "trace_xxx"
  },
  "meta": { "requestId": "req_xxx" },
  "feedback": []
}
```

**400 Bad Request â€” ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ì´ˆê³¼ (ì‹ ê·œ)**
```json
{
  "success": false,
  "data": null,
  "error": {
    "code": "MESSAGE.CONTEXT_TOO_LARGE",
    "httpStatus": 400,
    "message": "ì»¨í…ìŠ¤íŠ¸ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.",
    "details": {
      "total_chars": 75000,
      "max_chars": 50000
    },
    "hint": "max_messagesë¥¼ ì¤„ì´ê±°ë‚˜ include_artifact_contentë¥¼ falseë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.",
    "traceId": "trace_yyy"
  },
  "meta": { "requestId": "req_yyy" },
  "feedback": []
}
```

**403 Forbidden â€” ê¶Œí•œ ì—†ìŒ**
- `TOPIC.UNAUTHORIZED`: í† í”½ ì†Œìœ ì ì•„ë‹˜
- `ARTIFACT.UNAUTHORIZED`: ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ì•„í‹°íŒ©íŠ¸ ì ‘ê·¼

**404 Not Found**
- `TOPIC.NOT_FOUND`: í† í”½ ì—†ìŒ
- `ARTIFACT.NOT_FOUND`: artifact_id ì§€ì • ì‹œ ì—†ìŒ

**400 Bad Request â€” ì•„í‹°íŒ©íŠ¸ í˜•ì‹ ì˜¤ë¥˜**
- `ARTIFACT.INVALID_KIND`: MDê°€ ì•„ë‹Œ artifact (HWPX ë“±)

**503 Service Unavailable â€” Claude í˜¸ì¶œ ì‹¤íŒ¨**
- `SERVER.SERVICE_UNAVAILABLE`: Claude API ì¥ì• 

**500 Internal Server Error**
- `SERVER.INTERNAL_ERROR`: ê¸°íƒ€ ë‚´ë¶€ ì˜¤ë¥˜

---

## 3. ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± ë¡œì§ (ëª…í™•í™”)

### 3.1 ê¸°ë³¸ ì›ì¹™
- **user ë©”ì‹œì§€**: ëª¨ë‘ í¬í•¨ (`max_messages` ì œí•œ ê°€ëŠ¥)
- **assistant ë©”ì‹œì§€**: ì°¸ì¡° ë¬¸ì„œë¥¼ ìƒì„±í•œ ë©”ì‹œì§€ **1ê±´ë§Œ** í¬í•¨
- **ë¬¸ì„œ ë‚´ìš©**: `include_artifact_content=true`ì¼ ë•Œ ë³„ë„ user ë©”ì‹œì§€ë¡œ ì£¼ì…
- **ì •ë ¬**: `seq_no ASC` (ì‹œê°„ìˆœ)
- **ê¸¸ì´ ì œí•œ**: ì „ì²´ ì»¨í…ìŠ¤íŠ¸ 50,000ì ì»·ì˜¤í”„ (ì´ˆê³¼ ì‹œ 400 ì—ëŸ¬)

### 3.2 ì°¸ì¡° ë¬¸ì„œ ì„ íƒ ê·œì¹™

```python
# ì˜ì‚¬ì½”ë“œ
if artifact_id is not None:
    # ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ ì§€ì •
    reference_artifact = ArtifactDB.get_artifact_by_id(artifact_id)
    if not reference_artifact:
        return error_response(ErrorCode.ARTIFACT_NOT_FOUND, 404, ...)
    if reference_artifact.kind != ArtifactKind.MD:
        return error_response(ErrorCode.ARTIFACT_INVALID_KIND, 400, ...)
else:
    # ìµœì‹  MD ìë™ ì„ íƒ
    reference_artifact = ArtifactDB.get_latest_artifact_by_kind(
        topic_id, ArtifactKind.MD, topic.language
    )
    if not reference_artifact:
        # MDê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì°¸ì¡° ì—†ì´ ì§„í–‰ (graceful)
        reference_artifact = None
```

### 3.3 assistant ë©”ì‹œì§€ í¬í•¨ ê·œì¹™

```python
# ì˜ì‚¬ì½”ë“œ
all_messages = MessageDB.get_messages_by_topic(topic_id)

# User ë©”ì‹œì§€ í•„í„°ë§
user_messages = [m for m in all_messages if m.role == MessageRole.USER]
if max_messages is not None:
    user_messages = user_messages[-max_messages:]  # ìµœê·¼ Nê°œ

# Assistant ë©”ì‹œì§€ í•„í„°ë§ (ì°¸ì¡° ë¬¸ì„œë¥¼ ìƒì„±í•œ ë©”ì‹œì§€ 1ê±´ë§Œ)
assistant_messages = []
if reference_artifact:
    ref_assistant_msg = MessageDB.get_message_by_id(reference_artifact.message_id)
    if ref_assistant_msg:
        assistant_messages = [ref_assistant_msg]

# ì»¨í…ìŠ¤íŠ¸ ë°°ì—´ êµ¬ì„± (seq_no ìˆœìœ¼ë¡œ ì •ë ¬)
context_messages = sorted(
    user_messages + assistant_messages,
    key=lambda m: m.seq_no
)
```

### 3.4 ë¬¸ì„œ ë‚´ìš© ì£¼ì… ê·œì¹™

```python
# ì˜ì‚¬ì½”ë“œ
if include_artifact_content and reference_artifact:
    # íŒŒì¼ ì½ê¸°
    with open(reference_artifact.file_path, 'r', encoding='utf-8') as f:
        md_content = f.read()

    # ê¸¸ì´ ì œí•œ (ì•ˆì „ ì»·ì˜¤í”„)
    MAX_MD_CHARS = 30000
    if len(md_content) > MAX_MD_CHARS:
        md_content = md_content[:MAX_MD_CHARS] + "\n\n... (truncated)"

    # ë³„ë„ ë©”ì‹œì§€ë¡œ ì£¼ì… (role=user, ê°€ì¥ ìµœê·¼ ìœ„ì¹˜)
    artifact_context_msg = {
        "role": "user",
        "content": f"""í˜„ì¬ ë³´ê³ ì„œ(MD) ì›ë¬¸ì…ë‹ˆë‹¤. ê°œì • ì‹œ ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ì˜í•˜ì„¸ìš”.

```markdown
{md_content}
```"""
    }

    # ì»¨í…ìŠ¤íŠ¸ ëì— ì¶”ê°€ (ìµœì‹  ìœ„ì¹˜)
    context_messages.append(artifact_context_msg)
```

### 3.5 ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±

```python
# ì˜ì‚¬ì½”ë“œ
if system_prompt:
    # ì‚¬ìš©ì ì»¤ìŠ¤í…€ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
    final_system_prompt = system_prompt
else:
    # ê¸°ë³¸ í”„ë¡¬í”„íŠ¸ + í† í”½ ì£¼ì œ ë³´ê°•
    default_prompt = """ë‹¹ì‹ ì€ ê¸ˆìœµ ê¸°ê´€ì˜ ì „ë¬¸ ë³´ê³ ì„œ ì‘ì„±ìì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ì „ë¬¸ì ì´ê³  ê²©ì‹ìˆëŠ” ê¸ˆìœµ ì—…ë¬´ë³´ê³ ì„œë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë³´ê³ ì„œëŠ” ë‹¤ìŒ ì„¹ì…˜ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
- # ì œëª© (H1)
- ## ìš”ì•½ (H2)
- ## ë°°ê²½ ë° ëª©ì  (H2)
- ## ì£¼ìš” ë‚´ìš© (H2)
- ## ê²°ë¡  ë° ì œì–¸ (H2)

ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•˜ë˜, ê¸ˆìœµ ìš©ì–´ì™€ ë°ì´í„°ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì—¬ ì‹ ë¢°ì„±ì„ ë†’ì—¬ì£¼ì„¸ìš”.
ëª¨ë“  ì¶œë ¥ì€ Markdown í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤."""

    topic_context = f"\n\n**ëŒ€í™” ì£¼ì œ**: {topic.input_prompt}\nì´ì „ ë©”ì‹œì§€ë¥¼ ë¬¸ë§¥ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì¼ê´€ëœ ë¬¸ì²´ì™€ êµ¬ì¡°ë¡œ ë‹µë³€í•˜ì„¸ìš”."

    final_system_prompt = default_prompt + topic_context
```

### 3.6 ì „ì²´ ì»¨í…ìŠ¤íŠ¸ ê²€ì¦

```python
# ì˜ì‚¬ì½”ë“œ
# Claude APIë¡œ ì „ë‹¬í•  messages ë°°ì—´ êµ¬ì„±
claude_messages = [
    {"role": m.role.value, "content": m.content}
    for m in context_messages
]

# ê¸¸ì´ ê²€ì¦ (ì•ˆì „ ì œí•œ)
total_chars = sum(len(msg["content"]) for msg in claude_messages)
MAX_CONTEXT_CHARS = 50000

if total_chars > MAX_CONTEXT_CHARS:
    return error_response(
        code=ErrorCode.MESSAGE_CONTEXT_TOO_LARGE,
        http_status=400,
        message="ì»¨í…ìŠ¤íŠ¸ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.",
        details={"total_chars": total_chars, "max_chars": MAX_CONTEXT_CHARS},
        hint="max_messagesë¥¼ ì¤„ì´ê±°ë‚˜ include_artifact_contentë¥¼ falseë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”."
    )
```

---

## 4. ë°±ì—”ë“œ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### 4.1 ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ íë¦„

```python
@router.post("/api/topics/{topic_id}/ask", summary="Ask question in conversation")
async def ask(
    topic_id: int,
    body: AskRequest,
    current_user: User = Depends(get_current_active_user)
):
    """Ask a question in the conversation context.

    Args:
        topic_id: Topic ID
        body: Request body with content and options
        current_user: Authenticated user

    Returns:
        Standard ApiResponse with user_message, assistant_message, artifact, usage

    Error Codes:
        - TOPIC.NOT_FOUND: Topic not found
        - TOPIC.UNAUTHORIZED: User does not own this topic
        - VALIDATION.REQUIRED_FIELD: Content is empty
        - ARTIFACT.NOT_FOUND: Specified artifact not found
        - ARTIFACT.INVALID_KIND: Artifact is not MD
        - ARTIFACT.UNAUTHORIZED: Artifact belongs to different user
        - MESSAGE.CONTEXT_TOO_LARGE: Context size exceeds limit
        - SERVER.SERVICE_UNAVAILABLE: Claude API failure
    """

    # === 1ë‹¨ê³„: ê¶Œí•œ ë° ê²€ì¦ ===
    logger.info(f"[ASK] Start - topic_id={topic_id}, user_id={current_user.id}")

    topic = TopicDB.get_topic_by_id(topic_id)
    if not topic:
        logger.warning(f"[ASK] Topic not found - topic_id={topic_id}")
        return error_response(
            code=ErrorCode.TOPIC_NOT_FOUND,
            http_status=404,
            message="í† í”½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
        )

    if topic.user_id != current_user.id and not current_user.is_admin:
        logger.warning(f"[ASK] Unauthorized - topic_id={topic_id}, owner={topic.user_id}, requester={current_user.id}")
        return error_response(
            code=ErrorCode.TOPIC_UNAUTHORIZED,
            http_status=403,
            message="ì´ í† í”½ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."
        )

    content = (body.content or "").strip()
    if not content:
        logger.warning(f"[ASK] Empty content - topic_id={topic_id}")
        return error_response(
            code=ErrorCode.VALIDATION_REQUIRED_FIELD,
            http_status=400,
            message="ì…ë ¥ ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.",
            hint="1ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."
        )

    if len(content) > 50000:
        logger.warning(f"[ASK] Content too long - topic_id={topic_id}, length={len(content)}")
        return error_response(
            code=ErrorCode.VALIDATION_MAX_LENGTH_EXCEEDED,
            http_status=400,
            message="ì…ë ¥ ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤.",
            hint="50,000ì ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”."
        )

    # === 2ë‹¨ê³„: ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ ===
    logger.info(f"[ASK] Saving user message - topic_id={topic_id}, length={len(content)}")
    user_msg = MessageDB.create_message(
        topic_id,
        MessageCreate(role=MessageRole.USER, content=content)
    )
    logger.info(f"[ASK] User message saved - message_id={user_msg.id}, seq_no={user_msg.seq_no}")

    # === 3ë‹¨ê³„: ì°¸ì¡° ë¬¸ì„œ ì„ íƒ ===
    reference_artifact = None
    if body.artifact_id is not None:
        logger.info(f"[ASK] Loading specified artifact - artifact_id={body.artifact_id}")
        reference_artifact = ArtifactDB.get_artifact_by_id(body.artifact_id)

        if not reference_artifact:
            logger.warning(f"[ASK] Artifact not found - artifact_id={body.artifact_id}")
            return error_response(
                code=ErrorCode.ARTIFACT_NOT_FOUND,
                http_status=404,
                message="ì§€ì •í•œ ì•„í‹°íŒ©íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            )

        if reference_artifact.topic_id != topic_id:
            logger.warning(f"[ASK] Artifact topic mismatch - artifact.topic_id={reference_artifact.topic_id}, request.topic_id={topic_id}")
            return error_response(
                code=ErrorCode.ARTIFACT_UNAUTHORIZED,
                http_status=403,
                message="ì´ ì•„í‹°íŒ©íŠ¸ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."
            )

        if reference_artifact.kind != ArtifactKind.MD:
            logger.warning(f"[ASK] Invalid artifact kind - artifact_id={body.artifact_id}, kind={reference_artifact.kind}")
            return error_response(
                code=ErrorCode.ARTIFACT_INVALID_KIND,
                http_status=400,
                message="MD í˜•ì‹ì˜ ì•„í‹°íŒ©íŠ¸ë§Œ ì°¸ì¡°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
                details={"current_kind": reference_artifact.kind}
            )
    else:
        logger.info(f"[ASK] Loading latest MD artifact - topic_id={topic_id}")
        reference_artifact = ArtifactDB.get_latest_artifact_by_kind(
            topic_id, ArtifactKind.MD, topic.language
        )
        if reference_artifact:
            logger.info(f"[ASK] Latest artifact found - artifact_id={reference_artifact.id}, version={reference_artifact.version}")
        else:
            logger.info(f"[ASK] No MD artifact found - proceeding without reference")

    # === 4ë‹¨ê³„: ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± ===
    logger.info(f"[ASK] Building context - topic_id={topic_id}")

    all_messages = MessageDB.get_messages_by_topic(topic_id)
    logger.info(f"[ASK] Total messages in topic: {len(all_messages)}")

    # User ë©”ì‹œì§€ í•„í„°ë§
    user_messages = [m for m in all_messages if m.role == MessageRole.USER]
    if body.max_messages is not None:
        user_messages = user_messages[-body.max_messages:]
    logger.info(f"[ASK] User messages to include: {len(user_messages)}")

    # Assistant ë©”ì‹œì§€ í•„í„°ë§ (ì°¸ì¡° ë¬¸ì„œ ìƒì„± ë©”ì‹œì§€ë§Œ)
    assistant_messages = []
    if reference_artifact:
        ref_msg = MessageDB.get_message_by_id(reference_artifact.message_id)
        if ref_msg:
            assistant_messages = [ref_msg]
            logger.info(f"[ASK] Including reference assistant message - message_id={ref_msg.id}")

    # ì»¨í…ìŠ¤íŠ¸ ë°°ì—´ êµ¬ì„±
    context_messages = sorted(
        user_messages + assistant_messages,
        key=lambda m: m.seq_no
    )

    # ë¬¸ì„œ ë‚´ìš© ì£¼ì…
    if body.include_artifact_content and reference_artifact:
        logger.info(f"[ASK] Loading artifact content - artifact_id={reference_artifact.id}, path={reference_artifact.file_path}")

        try:
            with open(reference_artifact.file_path, 'r', encoding='utf-8') as f:
                md_content = f.read()

            original_length = len(md_content)
            MAX_MD_CHARS = 30000
            if len(md_content) > MAX_MD_CHARS:
                md_content = md_content[:MAX_MD_CHARS] + "\n\n... (truncated)"
                logger.info(f"[ASK] Artifact content truncated - original={original_length}, truncated={MAX_MD_CHARS}")

            artifact_msg = type('Message', (), {
                'role': MessageRole.USER,
                'content': f"""í˜„ì¬ ë³´ê³ ì„œ(MD) ì›ë¬¸ì…ë‹ˆë‹¤. ê°œì • ì‹œ ì´ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°˜ì˜í•˜ì„¸ìš”.

```markdown
{md_content}
```""",
                'seq_no': context_messages[-1].seq_no + 0.5 if context_messages else 0
            })()

            context_messages.append(artifact_msg)
            logger.info(f"[ASK] Artifact content injected - length={len(md_content)}")

        except Exception as e:
            logger.error(f"[ASK] Failed to load artifact content - error={str(e)}")
            return error_response(
                code=ErrorCode.ARTIFACT_DOWNLOAD_FAILED,
                http_status=500,
                message="ì•„í‹°íŒ©íŠ¸ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                details={"error": str(e)}
            )

    # Claude ë©”ì‹œì§€ ë°°ì—´ ë³€í™˜
    claude_messages = [
        {"role": m.role.value, "content": m.content}
        for m in context_messages
    ]

    # ê¸¸ì´ ê²€ì¦
    total_chars = sum(len(msg["content"]) for msg in claude_messages)
    MAX_CONTEXT_CHARS = 50000

    logger.info(f"[ASK] Context size - messages={len(claude_messages)}, total_chars={total_chars}, max={MAX_CONTEXT_CHARS}")

    if total_chars > MAX_CONTEXT_CHARS:
        logger.warning(f"[ASK] Context too large - total_chars={total_chars}")
        return error_response(
            code=ErrorCode.MESSAGE_CONTEXT_TOO_LARGE,
            http_status=400,
            message="ì»¨í…ìŠ¤íŠ¸ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤.",
            details={"total_chars": total_chars, "max_chars": MAX_CONTEXT_CHARS},
            hint="max_messagesë¥¼ ì¤„ì´ê±°ë‚˜ include_artifact_contentë¥¼ falseë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”."
        )

    # ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
    if body.system_prompt:
        system_prompt = body.system_prompt
        logger.info(f"[ASK] Using custom system prompt - length={len(system_prompt)}")
    else:
        default_prompt = """ë‹¹ì‹ ì€ ê¸ˆìœµ ê¸°ê´€ì˜ ì „ë¬¸ ë³´ê³ ì„œ ì‘ì„±ìì…ë‹ˆë‹¤.
ì‚¬ìš©ìì˜ ìš”ì²­ì— ë”°ë¼ ì „ë¬¸ì ì´ê³  ê²©ì‹ìˆëŠ” ê¸ˆìœµ ì—…ë¬´ë³´ê³ ì„œë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.

ë³´ê³ ì„œëŠ” ë‹¤ìŒ ì„¹ì…˜ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:
- # ì œëª© (H1)
- ## ìš”ì•½ (H2)
- ## ë°°ê²½ ë° ëª©ì  (H2)
- ## ì£¼ìš” ë‚´ìš© (H2)
- ## ê²°ë¡  ë° ì œì–¸ (H2)

ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•˜ë˜, ê¸ˆìœµ ìš©ì–´ì™€ ë°ì´í„°ë¥¼ ì ì ˆíˆ í™œìš©í•˜ì—¬ ì‹ ë¢°ì„±ì„ ë†’ì—¬ì£¼ì„¸ìš”.
ëª¨ë“  ì¶œë ¥ì€ Markdown í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤."""

        topic_context = f"\n\n**ëŒ€í™” ì£¼ì œ**: {topic.input_prompt}\nì´ì „ ë©”ì‹œì§€ë¥¼ ë¬¸ë§¥ìœ¼ë¡œ í™œìš©í•˜ì—¬ ì¼ê´€ëœ ë¬¸ì²´ì™€ êµ¬ì¡°ë¡œ ë‹µë³€í•˜ì„¸ìš”."
        system_prompt = default_prompt + topic_context
        logger.info(f"[ASK] Using default system prompt with topic context")

    # === 5ë‹¨ê³„: Claude í˜¸ì¶œ ===
    logger.info(f"[ASK] Calling Claude API - model={ClaudeClient().model}, messages={len(claude_messages)}")

    try:
        import time
        t0 = time.time()

        claude_client = ClaudeClient()
        response_text, input_tokens, output_tokens = claude_client.chat_completion(
            claude_messages,
            system_prompt
        )

        latency_ms = int((time.time() - t0) * 1000)

        logger.info(f"[ASK] Claude response received - input_tokens={input_tokens}, output_tokens={output_tokens}, latency_ms={latency_ms}")

    except Exception as e:
        logger.error(f"[ASK] Claude API call failed - error={str(e)}")
        return error_response(
            code=ErrorCode.SERVER_SERVICE_UNAVAILABLE,
            http_status=503,
            message="AI ì‘ë‹µ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
            details={"error": str(e)},
            hint="ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
        )

    # === 6ë‹¨ê³„: Assistant ë©”ì‹œì§€ ì €ì¥ ===
    logger.info(f"[ASK] Saving assistant message - topic_id={topic_id}, length={len(response_text)}")

    asst_msg = MessageDB.create_message(
        topic_id,
        MessageCreate(role=MessageRole.ASSISTANT, content=response_text)
    )

    logger.info(f"[ASK] Assistant message saved - message_id={asst_msg.id}, seq_no={asst_msg.seq_no}")

    # === 7ë‹¨ê³„: MD íŒŒì¼ ì €ì¥ (í•„ìˆ˜) ===
    logger.info(f"[ASK] Saving MD artifact - topic_id={topic_id}")

    try:
        from app.utils.file_utils import next_artifact_version, build_artifact_paths, write_text, sha256_of

        # ë²„ì „ ê³„ì‚°
        version = next_artifact_version(topic_id, ArtifactKind.MD, topic.language)
        logger.info(f"[ASK] Artifact version - version={version}")

        # íŒŒì¼ ê²½ë¡œ ìƒì„±
        base_dir, md_path = build_artifact_paths(topic_id, version, "report.md")
        logger.info(f"[ASK] Artifact path - path={md_path}")

        # íŒŒì¼ ì €ì¥
        bytes_written = write_text(md_path, response_text)
        file_hash = sha256_of(md_path)

        logger.info(f"[ASK] File written - size={bytes_written}, hash={file_hash[:16]}...")

        # Artifact DB ë ˆì½”ë“œ ìƒì„±
        artifact = ArtifactDB.create_artifact(
            topic_id,
            asst_msg.id,
            ArtifactCreate(
                kind=ArtifactKind.MD,
                locale=topic.language,
                version=version,
                filename=md_path.name,
                file_path=str(md_path),
                file_size=bytes_written,
                sha256=file_hash
            )
        )

        logger.info(f"[ASK] Artifact created - artifact_id={artifact.id}, version={artifact.version}")

    except Exception as e:
        logger.error(f"[ASK] Failed to save artifact - error={str(e)}")
        return error_response(
            code=ErrorCode.ARTIFACT_CREATION_FAILED,
            http_status=500,
            message="ì‘ë‹µ íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.",
            details={"error": str(e)}
        )

    # === 8ë‹¨ê³„: AI ì‚¬ìš©ëŸ‰ ì €ì¥ ===
    logger.info(f"[ASK] Saving AI usage - message_id={asst_msg.id}")

    try:
        from app.database.ai_usage_db import AiUsageDB
        from app.models.ai_usage import AiUsageCreate

        AiUsageDB.create_ai_usage(
            topic_id,
            asst_msg.id,
            AiUsageCreate(
                model=claude_client.model,
                input_tokens=input_tokens,
                output_tokens=output_tokens,
                latency_ms=latency_ms
            )
        )

        logger.info(f"[ASK] AI usage saved")

    except Exception as e:
        logger.error(f"[ASK] Failed to save AI usage - error={str(e)}")
        # ì‚¬ìš©ëŸ‰ ì €ì¥ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì ì´ì§€ ì•Šìœ¼ë¯€ë¡œ ê³„ì† ì§„í–‰

    # === 9ë‹¨ê³„: ì„±ê³µ ì‘ë‹µ ë°˜í™˜ ===
    logger.info(f"[ASK] Success - topic_id={topic_id}, artifact_id={artifact.id}")

    return success_response({
        "topic_id": topic_id,
        "user_message": MessageResponse.model_validate(user_msg).model_dump(),
        "assistant_message": MessageResponse.model_validate(asst_msg).model_dump(),
        "artifact": ArtifactResponse.model_validate(artifact).model_dump(),
        "usage": {
            "model": claude_client.model,
            "input_tokens": input_tokens,
            "output_tokens": output_tokens,
            "latency_ms": latency_ms
        }
    })
```

---

## 5. Request/Response ëª¨ë¸ ì •ì˜

### 5.1 Request Model

**íŒŒì¼**: `backend/app/models/message.py`

```python
from pydantic import BaseModel, Field
from typing import Optional


class AskRequest(BaseModel):
    """Request model for asking question in conversation.

    Attributes:
        content: User question (1-50,000 chars)
        artifact_id: Specific artifact to reference (null = use latest MD)
        include_artifact_content: Include file content in context (default: true)
        max_messages: Max number of user messages to include (null = all)
        system_prompt: Custom system prompt (optional)
    """

    content: str = Field(
        ...,
        min_length=1,
        max_length=50000,
        description="User question text"
    )

    artifact_id: Optional[int] = Field(
        default=None,
        description="Artifact ID to reference (null = use latest MD)"
    )

    include_artifact_content: bool = Field(
        default=True,
        description="Include artifact file content in context"
    )

    max_messages: Optional[int] = Field(
        default=None,
        ge=1,
        le=100,
        description="Maximum number of user messages to include"
    )

    system_prompt: Optional[str] = Field(
        default=None,
        max_length=10000,
        description="Custom system prompt"
    )
```

---

## 6. ErrorCode ì¶”ê°€ ì •ì˜

**íŒŒì¼**: `backend/app/utils/response_helper.py`

```python
class ErrorCode:
    # ... ê¸°ì¡´ ì½”ë“œ ...

    # Message errors (MESSAGE.*)
    MESSAGE_NOT_FOUND = "MESSAGE.NOT_FOUND"
    MESSAGE_CREATION_FAILED = "MESSAGE.CREATION_FAILED"
    MESSAGE_INVALID_ROLE = "MESSAGE.INVALID_ROLE"
    MESSAGE_CONTEXT_TOO_LARGE = "MESSAGE.CONTEXT_TOO_LARGE"  # ì‹ ê·œ ì¶”ê°€
```

---

## 7. ë¡œê¹… ì „ëµ

### 7.1 ë¡œê¹… ë ˆë²¨ ì •ì±…
- **INFO**: ì •ìƒ íë¦„ì˜ ì£¼ìš” ë‹¨ê³„
- **WARNING**: ë¹„ì •ìƒì ì´ë‚˜ ì²˜ë¦¬ ê°€ëŠ¥í•œ ìƒí™© (404, 403 ë“±)
- **ERROR**: ì˜ˆì™¸ ë°œìƒ ë° ì‹¤íŒ¨ ì¼€ì´ìŠ¤

### 7.2 ë¡œê¹… í¬ë§·
```python
logger.info(f"[ASK] {stage} - key1={value1}, key2={value2}")
```

### 7.3 í•„ìˆ˜ ë¡œê¹… ì§€ì 
1. **ìš”ì²­ ì‹œì‘**: topic_id, user_id
2. **ê¶Œí•œ ê²€ì¦**: ì„±ê³µ/ì‹¤íŒ¨
3. **ë©”ì‹œì§€ ì €ì¥**: message_id, seq_no
4. **ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±**: ë©”ì‹œì§€ ìˆ˜, ì´ ë¬¸ì ìˆ˜
5. **Claude í˜¸ì¶œ**: ëª¨ë¸, í† í° ìˆ˜, ì§€ì—°ì‹œê°„
6. **íŒŒì¼ ì €ì¥**: ê²½ë¡œ, í¬ê¸°, í•´ì‹œ
7. **ì‘ë‹µ ë°˜í™˜**: artifact_id

---

## 8. í…ŒìŠ¤íŠ¸ ê³„íš

### 8.1 ë‹¨ìœ„ í…ŒìŠ¤íŠ¸

**íŒŒì¼**: `backend/tests/test_routers_messages_ask.py`

```python
import pytest
from unittest.mock import patch


@pytest.mark.api
class TestAskEndpoint:
    """Ask endpoint tests"""

    def test_ask_success_no_artifact(self, client, auth_headers, create_test_user):
        """ì°¸ì¡° ë¬¸ì„œ ì—†ì´ ì§ˆë¬¸ ì„±ê³µ"""
        # 1. í† í”½ ìƒì„±
        topic = TopicDB.create_topic(...)

        # 2. Mock Claude
        with patch('app.utils.claude_client.Anthropic') as mock:
            mock_instance = MagicMock()
            mock_instance.messages.create.return_value.content = [
                type('Content', (), {'text': "# ì‘ë‹µ\n\në‚´ìš©..."})()
            ]
            mock_instance.messages.create.return_value.usage.input_tokens = 100
            mock_instance.messages.create.return_value.usage.output_tokens = 200
            mock.return_value = mock_instance

            # 3. Ask í˜¸ì¶œ
            response = client.post(
                f"/api/topics/{topic.id}/ask",
                headers=auth_headers,
                json={"content": "ë””ì§€í„¸ë±…í‚¹ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”."}
            )

        # 4. ê²€ì¦
        assert response.status_code == 200
        body = response.json()
        assert body["success"] is True
        assert body["data"]["artifact"]["kind"] == "md"
        assert body["data"]["usage"]["input_tokens"] == 100

    def test_ask_with_latest_md(self, client, auth_headers, create_test_user):
        """ìµœì‹  MD ì°¸ì¡°í•˜ì—¬ ì§ˆë¬¸"""
        # 1. í† í”½ + MD artifact ìƒì„±
        topic = TopicDB.create_topic(...)
        msg = MessageDB.create_message(...)
        artifact = ArtifactDB.create_artifact(..., kind=ArtifactKind.MD, ...)

        # 2. Ask í˜¸ì¶œ (artifact_id=None, ìë™ìœ¼ë¡œ latest ì‚¬ìš©)
        with patch('app.utils.claude_client.Anthropic'):
            response = client.post(
                f"/api/topics/{topic.id}/ask",
                headers=auth_headers,
                json={"content": "ì´ì „ ë³´ê³ ì„œë¥¼ ìš”ì•½í•´ì£¼ì„¸ìš”."}
            )

        # 3. ì»¨í…ìŠ¤íŠ¸ì— ìµœì‹  MD í¬í•¨ í™•ì¸ (ë¡œê·¸ ë˜ëŠ” Mock í˜¸ì¶œ ê²€ì¦)
        assert response.status_code == 200

    def test_ask_with_specific_md(self, client, auth_headers, create_test_user):
        """íŠ¹ì • MD ì§€ì •í•˜ì—¬ ì§ˆë¬¸"""
        # ì—¬ëŸ¬ ë²„ì „ MD ìƒì„± í›„ íŠ¹ì • ID ì§€ì •
        pass

    def test_ask_context_too_large(self, client, auth_headers, create_test_user):
        """ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ì´ˆê³¼"""
        # ë§¤ìš° ê¸´ ë©”ì‹œì§€ë“¤ ìƒì„± í›„ ìš”ì²­
        # 400 MESSAGE.CONTEXT_TOO_LARGE í™•ì¸
        pass

    def test_ask_artifact_not_found(self, client, auth_headers, create_test_user):
        """ì¡´ì¬í•˜ì§€ ì•ŠëŠ” artifact_id"""
        topic = TopicDB.create_topic(...)

        response = client.post(
            f"/api/topics/{topic.id}/ask",
            headers=auth_headers,
            json={"content": "ì§ˆë¬¸", "artifact_id": 999999}
        )

        assert response.status_code == 404
        assert response.json()["error"]["code"] == "ARTIFACT.NOT_FOUND"

    def test_ask_artifact_wrong_kind(self, client, auth_headers, create_test_user):
        """HWPX artifact ì°¸ì¡° ì‹œë„"""
        # HWPX artifact ìƒì„± í›„ artifact_id ì§€ì •
        # 400 ARTIFACT.INVALID_KIND í™•ì¸
        pass

    def test_ask_unauthorized_topic(self, client, auth_headers, create_admin_user):
        """íƒ€ì¸ì˜ í† í”½ì— ì§ˆë¬¸"""
        # User Aì˜ í† í”½ ìƒì„±
        # User Bë¡œ ìš”ì²­
        # 403 TOPIC.UNAUTHORIZED í™•ì¸
        pass

    def test_ask_max_messages_limit(self, client, auth_headers, create_test_user):
        """max_messages ì œí•œ"""
        # 50ê°œ user ë©”ì‹œì§€ ìƒì„±
        # max_messages=10 ì„¤ì •
        # ìµœê·¼ 10ê°œë§Œ í¬í•¨ í™•ì¸
        pass
```

---

## 9. ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

### 9.1 ê¸°ì¡´ ì—”ë“œí¬ì¸íŠ¸ì™€ì˜ ê³µì¡´
- ê¸°ì¡´: `POST /api/topics/{topic_id}/messages` (ì‹œìŠ¤í…œ ì „ìš©)
- ì‹ ê·œ: `POST /api/topics/{topic_id}/ask` (ì‚¬ìš©ì ëŒ€í™”ìš©)

### 9.2 í”„ë¡ íŠ¸ì—”ë“œ ì „í™˜
- ê¸°ì¡´ UIëŠ” `ask` ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©ìœ¼ë¡œ ì „í™˜
- `messages` ì—”ë“œí¬ì¸íŠ¸ëŠ” ê´€ë¦¬ì/ì´ê´€ ìš©ë„ë¡œë§Œ ì‚¬ìš©

---

## 10. êµ¬í˜„ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: MVP (2ì¼)
- [ ] `AskRequest` ëª¨ë¸ ì •ì˜
- [ ] `POST /api/topics/{topic_id}/ask` ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„
- [ ] ê¶Œí•œ/ê²€ì¦ ë¡œì§
- [ ] ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± (user ì „ì²´ + latest MDì˜ assistant)
- [ ] Claude í˜¸ì¶œ ë° ì‘ë‹µ ì €ì¥
- [ ] MD íŒŒì¼ ìë™ ì €ì¥ (í•„ìˆ˜)
- [ ] AI ì‚¬ìš©ëŸ‰ ê¸°ë¡
- [ ] ErrorCode ì¶”ê°€ (`MESSAGE.CONTEXT_TOO_LARGE`)
- [ ] ë¡œê¹… ì¶”ê°€ (ì „ ë‹¨ê³„)
- [ ] ê¸°ë³¸ í…ŒìŠ¤íŠ¸ (ì„±ê³µ/ì‹¤íŒ¨)

### Phase 2: ì˜µì…˜ ê¸°ëŠ¥ (1ì¼)
- [ ] `artifact_id` ëª…ì‹œì  ì§€ì •
- [ ] `include_artifact_content` êµ¬í˜„
- [ ] `max_messages` ì œí•œ
- [ ] ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ê²€ì¦
- [ ] ì¶”ê°€ í…ŒìŠ¤íŠ¸ (ì˜µì…˜ ì¡°í•©)

### Phase 3: ì•ˆì •í™” (1ì¼)
- [ ] ë¡œê¹… ê²€ì¦
- [ ] ì—ëŸ¬ ì¼€ì´ìŠ¤ ì „ì²´ í…ŒìŠ¤íŠ¸
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ (README/CLAUDE.md)
- [ ] í”„ë¡ íŠ¸ì—”ë“œ ì—°ë™ ê°€ì´ë“œ

---

## 11. ì„±ëŠ¥/ë¹„ìš© ê³ ë ¤

### 11.1 í† í° ë¹„ìš© ì œì–´
- `max_messages`ë¡œ ì»¨í…ìŠ¤íŠ¸ í¬ê¸° ì œí•œ
- ë¬¸ì„œ ë‚´ìš© 30,000ì ì»·ì˜¤í”„
- ì „ì²´ ì»¨í…ìŠ¤íŠ¸ 50,000ì í•˜ë“œ ë¦¬ë¯¸íŠ¸

### 11.2 Rate Limiting (ì¶”í›„)
- ì‚¬ìš©ìë‹¹ ë¶„ë‹¹ 10íšŒ ì œí•œ
- IP ê¸°ë°˜ ì œí•œ ê³ ë ¤

### 11.3 ëª¨ë‹ˆí„°ë§
- í† í° ì‚¬ìš©ëŸ‰ ëŒ€ì‹œë³´ë“œ
- í‰ê·  ì§€ì—°ì‹œê°„ ì¶”ì 
- ì—ëŸ¬ìœ¨ ëª¨ë‹ˆí„°ë§

---

## ë¶€ë¡ A: API í˜¸ì¶œ ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ìµœì´ˆ ì§ˆë¬¸ (ì°¸ì¡° ë¬¸ì„œ ì—†ìŒ)
```bash
POST /api/topics/12/ask
Authorization: Bearer {token}

{
  "content": "2025ë…„ ë””ì§€í„¸ë±…í‚¹ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”."
}
```

### ì˜ˆì‹œ 2: í›„ì† ì§ˆë¬¸ (ìµœì‹  MD ìë™ ì°¸ì¡°)
```bash
POST /api/topics/12/ask
Authorization: Bearer {token}

{
  "content": "ì´ì „ ë¶„ì„ì— ESG ë¦¬ìŠ¤í¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”."
}
```

### ì˜ˆì‹œ 3: íŠ¹ì • ë²„ì „ ì°¸ì¡°
```bash
POST /api/topics/12/ask
Authorization: Bearer {token}

{
  "content": "v2 ë³´ê³ ì„œë¥¼ ê¸°ì¤€ìœ¼ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”.",
  "artifact_id": 345
}
```

### ì˜ˆì‹œ 4: íŒŒì¼ ë‚´ìš© ì œì™¸ (assistant ë©”ì‹œì§€ë§Œ)
```bash
POST /api/topics/12/ask
Authorization: Bearer {token}

{
  "content": "ì´ì „ ë‹µë³€ì„ ê°„ë‹¨íˆ ìš”ì•½í•´ì£¼ì„¸ìš”.",
  "include_artifact_content": false
}
```

---

**ë¬¸ì„œ ë²„ì „**: 2.0
**ìµœì¢… ê²€í† **: 2025-10-30
**ìŠ¹ì¸**: ê¸°ìˆ  ë¦¬ë“œ
