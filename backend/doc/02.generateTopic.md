# 토픽 기반 보고서 생성 기능 설계 · 구현 기록

본 문서는 “사용자 주제 입력 → Claude 생성 → 토픽/메시지/아티팩트/사용량 저장 → 경로 반환” 기능에 대한 계획, 구현 내역, 후속 과제, 함수 흐름도를 정리합니다.

---

## 1) 작업 계획(Plan)
- 엔드포인트 설계: `POST /api/topics/generate`
  - 입력: `input_prompt`, 선택 `language`
  - 출력: `topic_id`, `md_path`
- Claude 연동: `ClaudeClient.generate_report(topic)` 호출로 보고서 섹션 생성
- 데이터 저장(트랜잭션 관점):
  - Topic 생성(+ `generated_title` 반영)
  - Message 2건 저장 (user 입력, assistant 생성결과)
  - Markdown 파일 생성/저장 → Artifact 레코드 저장
  - AI 사용량(ai_usage) 저장(토큰/지연시간)
- 유틸 추가:
  - Markdown 빌더: Claude 결과 → Markdown 변환
  - 파일 유틸: 경로/버전/쓰기/해시
- 권한·검증:
  - 인증 사용자만 사용 가능
  - 입력값 최소 유효성 검사(빈 문자열 방지)
- 아티팩트 접근 API 활용:
  - 텍스트 미리보기: `GET /api/artifacts/{artifact_id}/content` (MD 전용)
  - 다운로드: `GET /api/artifacts/{artifact_id}/download`

---

## 2) 작업 내용(Implementation)

### 2-1) 라우터 추가/확장
- 파일: `backend/app/routers/topics.py`
- 엔드포인트: `POST /api/topics/generate`
- 처리 순서:
  1. 입력 검증(`input_prompt` 비어있지 않은지 확인)
  2. Claude 호출 → 섹션별 결과 수신, 토큰·지연시간 수집
  3. Topic 생성 후 `generated_title` 업데이트
  4. Message 저장
     - user: 입력 프롬프트
     - assistant: Markdown 결과 전문
  5. Markdown 파일 생성/저장(`backend/artifacts/{topic_id}/v{version}/report.md`)
  6. Artifact 저장(kind: md, locale: 언어, version: 증가)
  7. AI 사용량 저장(모델, 토큰, latency)
  8. 응답 반환: `{"topic_id": number, "md_path": string}`

### 2-2) 유틸 추가
- 파일: `backend/app/utils/markdown_builder.py`
  - `build_report_md(parsed: Dict[str, str]) -> str`
  - Claude 결과를 `# 제목` + `## 섹션` 구조 Markdown으로 변환
- 파일: `backend/app/utils/file_utils.py`
  - `next_artifact_version(topic_id, kind, locale)`
  - `build_artifact_paths(topic_id, version, filename)`
  - `write_text(file_path, text)` / `sha256_of(file_path)`

### 2-3) 기존 라우터 재사용(아티팩트)
- 파일: `backend/app/routers/artifacts.py`
  - 콘텐츠 미리보기: `GET /api/artifacts/{artifact_id}/content` (MD만)
  - 다운로드: `GET /api/artifacts/{artifact_id}/download`
  - 모든 엔드포인트에서 소유자/관리자 권한 검사 수행

### 2-4) 사용 모델/DB 레이어
- Claude 클라이언트: `backend/app/utils/claude_client.py`
- Topic: `backend/app/database/topic_db.py`, `backend/app/models/topic.py`
- Message: `backend/app/database/message_db.py`, `backend/app/models/message.py`
- Artifact: `backend/app/database/artifact_db.py`, `backend/app/models/artifact.py`
- AI 사용량: `backend/app/database/ai_usage_db.py`, `backend/app/models/ai_usage.py`
- 공통 Enum: `shared/types/enums.py`

---

## 3) 향후 필요한 사항(Next)
- 트랜잭션 보강: 파일 저장과 DB 쓰기를 하나의 원자적 작업처럼 다루기 위해 try/except 내 롤백 로직 보강
- 응답 확장: 생성 직후의 `artifact_id`를 함께 반환하여, 프론트에서 즉시 미리보기 API 호출 가능하도록 개선(`md_path` + `artifact_id`)
- 콘텐츠 보안: 파일 절대경로 노출 최소화(상대경로/식별자 기반 접근으로 일원화)
- 유효성 강화: `input_prompt` 길이 제한/금칙어 등 추가 검증
- 어시스턴트 메시지 요약 저장(선택): 대용량 Markdown 본문 대신 요약을 메시지에 저장하고, 파일에는 전문 저장
- 에러 코드 통일: `ErrorCode` 상수와 메시지를 CLAUDE/README 가이드와 일관되게 정리
- 추가 포맷: HWPX 변환 파이프라인 연결(Artifact kind=hwpx), 변환/번역 트랜스폼 기록(`transformation_db`)

---

## 4) 함수 흐름도(Flow)

대상: `topics.py` 내 `generate_topic_report`

```text
[Client]
  │ POST /api/topics/generate {input_prompt, language}
  ▼
[Auth] get_current_active_user → user 확인
  ▼
[ClaudeClient]
  - start timer
  - generate_report(input_prompt)
  - 결과: {title, summary, background, main_content, conclusion, ...}
  - 토큰/지연시간 기록
  ▼
[DB: Topic]
  - create_topic(user_id, input_prompt, language, status=active)
  - update_topic(generated_title=title)
  ▼
[DB: Message]
  - create_message(role=user, content=input_prompt)
  ▼
[Markdown]
  - build_report_md(result) → md_text
  ▼
[File]
  - next_artifact_version(kind=md, locale)
  - build_artifact_paths(topic_id, version, "report.md")
  - write_text(md_path, md_text) / sha256_of(md_path)
  ▼
[DB: Message]
  - create_message(role=assistant, content=md_text)
  ▼
[DB: Artifact]
  - create_artifact(topic_id, message_id=assistant_msg.id, kind=md, ...)
  ▼
[DB: AiUsage]
  - create_ai_usage(model, input_tokens, output_tokens, latency_ms)
  ▼
[Response]
  - { topic_id, md_path }
```

---

## 5) 간단 사용 예시(API)
- 생성:
  - `POST /api/topics/generate`
  - Body: `{ "input_prompt": "디지털뱅킹 트렌드 분석", "language": "ko" }`
  - Res: `{ "topic_id": 12, "md_path": ".../backend/artifacts/12/v1/report.md" }`
- 미리보기:
  - `GET /api/artifacts/{artifact_id}/content`
- 다운로드:
  - `GET /api/artifacts/{artifact_id}/download`

```note
권한: 모든 API는 인증 사용자만 사용 가능. 아티팩트 접근은 소유자/관리자만 허용.
```

---

## 변경 파일 요약(참고)
- `backend/app/routers/topics.py` — 생성 API 추가, 어시스턴트 메시지 저장, 아티팩트/사용량 연동
- `backend/app/utils/markdown_builder.py` — Markdown 생성 유틸
- `backend/app/utils/file_utils.py` — 파일/버전/해시 유틸
- `backend/app/routers/artifacts.py` — 콘텐츠/다운로드 엔드포인트 활용(기존)
