<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ - HWP ë³´ê³ ì„œ ìë™ ìƒì„± ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container auth-container">
        <header>
            <h1>ğŸ“„ HWP ë³´ê³ ì„œ ìë™ ìƒì„± ì‹œìŠ¤í…œ</h1>
            <p class="subtitle">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</p>
        </header>

        <main>
            <div class="card auth-card">
                <div class="alert alert-warning" id="resetNotice" style="display: none;">
                    <strong>âš ï¸ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìš”</strong>
                    <p>ê´€ë¦¬ìê°€ ê·€í•˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ ìƒˆë¡œìš´ ë¹„ë°€ë²ˆí˜¸ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”.</p>
                </div>

                <h2>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h2>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input
                            type="password"
                            id="currentPassword"
                            name="currentPassword"
                            placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="newPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input
                            type="password"
                            id="newPassword"
                            name="newPassword"
                            placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (8ì ì´ìƒ)"
                            required
                            minlength="8"
                        >
                        <small>ìµœì†Œ 8ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.</small>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input
                            type="password"
                            id="confirmPassword"
                            name="confirmPassword"
                            placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                            required
                        >
                    </div>

                    <div id="result" class="result" style="display: none;"></div>

                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</span>
                    </button>
                </form>

                <div class="auth-links">
                    <p><a href="/">ë©”ì¸ í˜ì´ì§€ë¡œ</a></p>
                </div>
            </div>
        </main>

        <footer>
            <p>Â© 2025 HWP Report Generator | Powered by KJBank R&D HanTJ</p>
        </footer>
    </div>

    <script>
        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í•„ìˆ˜ ì—¬ë¶€ í™•ì¸
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.password_reset_required) {
            document.getElementById('resetNotice').style.display = 'block';
        }

        // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ í¼ ì²˜ë¦¬
        const changePasswordForm = document.getElementById('changePasswordForm');
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resultDiv = document.getElementById('result');

            // ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸
            if (newPassword !== confirmPassword) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                resultDiv.style.display = 'block';
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = data.message + ' ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...';
                    resultDiv.style.display = 'block';

                    // ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸ (password_reset_required = false)
                    const updatedUser = {...user, password_reset_required: false};
                    localStorage.setItem('user', JSON.stringify(updatedUser));

                    // ë©”ì¸ í˜ì´ì§€ë¡œ ì´ë™
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = data.detail || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = 'ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                resultDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>
