<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>비밀번호 변경 - HWP 보고서 자동 생성 시스템</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container auth-container">
        <header>
            <h1>📄 HWP 보고서 자동 생성 시스템</h1>
            <p class="subtitle">비밀번호 변경</p>
        </header>

        <main>
            <div class="card auth-card">
                <div class="alert alert-warning" id="resetNotice" style="display: none;">
                    <strong>⚠️ 비밀번호 변경 필요</strong>
                    <p>관리자가 귀하의 비밀번호를 초기화했습니다. 보안을 위해 새로운 비밀번호로 변경해주세요.</p>
                </div>

                <h2>비밀번호 변경</h2>
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label for="currentPassword">현재 비밀번호</label>
                        <input
                            type="password"
                            id="currentPassword"
                            name="currentPassword"
                            placeholder="현재 비밀번호를 입력하세요"
                            required
                        >
                    </div>

                    <div class="form-group">
                        <label for="newPassword">새 비밀번호</label>
                        <input
                            type="password"
                            id="newPassword"
                            name="newPassword"
                            placeholder="새 비밀번호를 입력하세요 (8자 이상)"
                            required
                            minlength="8"
                        >
                        <small>최소 8자 이상 입력해주세요.</small>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword">새 비밀번호 확인</label>
                        <input
                            type="password"
                            id="confirmPassword"
                            name="confirmPassword"
                            placeholder="새 비밀번호를 다시 입력하세요"
                            required
                        >
                    </div>

                    <div id="result" class="result" style="display: none;"></div>

                    <button type="submit" class="btn btn-primary">
                        <span class="btn-text">비밀번호 변경</span>
                    </button>
                </form>

                <div class="auth-links">
                    <p><a href="/">메인 페이지로</a></p>
                </div>
            </div>
        </main>

        <footer>
            <p>© 2025 HWP Report Generator | Powered by KJBank R&D HanTJ</p>
        </footer>
    </div>

    <script>
        // 비밀번호 변경 필수 여부 확인
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (user.password_reset_required) {
            document.getElementById('resetNotice').style.display = 'block';
        }

        // 비밀번호 변경 폼 처리
        const changePasswordForm = document.getElementById('changePasswordForm');
        changePasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const resultDiv = document.getElementById('result');

            // 새 비밀번호 확인
            if (newPassword !== confirmPassword) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '새 비밀번호가 일치하지 않습니다.';
                resultDiv.style.display = 'block';
                return;
            }

            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = data.message + ' 메인 페이지로 이동합니다...';
                    resultDiv.style.display = 'block';

                    // 사용자 정보 업데이트 (password_reset_required = false)
                    const updatedUser = {...user, password_reset_required: false};
                    localStorage.setItem('user', JSON.stringify(updatedUser));

                    // 메인 페이지로 이동
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 2000);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = data.detail || '비밀번호 변경에 실패했습니다.';
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = '서버 연결에 실패했습니다.';
                resultDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>
